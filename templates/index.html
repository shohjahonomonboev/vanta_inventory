{% extends "base.html" %}
{% block title %}{{ t("app_name") }}{% endblock %}
{% block content %}

<div class="logo-container" style="text-align:center;margin-bottom:8px;">
  <img src="{{ url_for('static', filename='jasurbek_logo.png') }}" class="logo" alt="Jasurbek Logo" style="max-height:64px;">
</div>

<h1>{{ t("app_name") }}</h1>
<p class="subtitle">{{ t("welcome_back") }}</p>

<!-- KPIs -->
<div class="kpis">
  <div class="kpi kpi-green">
    <strong>{{ t("todays_revenue") }}</strong>
    {{ today_revenue | ccy | fmtmoney }}
  </div>
  <div class="kpi kpi-blue">
    <strong>{{ t("todays_profit") }}</strong>
    {{ today_profit | ccy | fmtmoney }}
  </div>
</div>

<!-- Sell Item -->
<h2>{{ t("sell_item") }}</h2>
<form action="{{ url_for('sell_item') }}" method="POST" class="form-row card" style="padding:12px;">
  <select name="item_id" required id="sell-item-select" aria-label="{{ t('item') }}">
    {% for item in inventory %}
      {# item: (id, name, buy, sell, qty, profit, currency) #}
      <option value="{{ item[0] }}">
        {{ item[1] }} — {{ t('stock') }}: {{ item[4] }} — {{ t('sell') }}: {{ (item[3] | ccy) | fmtmoney }}
      </option>
    {% endfor %}
  </select>
  <input type="number" name="qty" placeholder="{{ t('qty') }}" min="1" required>
  <input type="text" name="sell_price" id="sell-price" data-money data-decimals="0" placeholder="{{ t('sell_price') }} ({{ CURRENCY }})" required>
  <button type="submit">{{ t('sell') }}</button>
</form>

<script>
  // Prefill sell price (UI currency)
  const priceMap = {
    {% for item in inventory -%}
      "{{ item[0] }}": {{ item[3] | ccy | float }},
    {%- endfor %}
  };
  (function(){
    const sel = document.getElementById('sell-item-select');
    const priceInput = document.getElementById('sell-price');
    if (!sel || !priceInput) return;
    function setPrice(){
      const v = priceMap[sel.value];
      priceInput.value = v != null ? String(Math.round(Number(v))) : "";
      priceInput.dispatchEvent(new Event('input'));
    }
    sel.addEventListener('change', setPrice);
    setPrice();
  })();
</script>

<!-- Add Item -->
<h2 class="section-title">
  {{ t("add_item") or "Add Item" }}
  <span class="info" role="button" tabindex="0"
        aria-label="Pricing hint"
        data-tip="Prices you enter are in UI currency {{ CURRENCY }}. They're stored internally in UZS.">
    <i class="fa-regular fa-circle-question"></i>
  </span>
</h2>

<form action="{{ url_for('add_item') }}" method="POST" class="form-row card" style="padding:12px;">
  <input type="text" name="name" placeholder="{{ t('item') }}" required>
  <input type="text" name="buying_price"  data-money data-decimals="0" placeholder="{{ t('buy') }} ({{ CURRENCY }})" required>
  <input type="text" name="selling_price" data-money data-decimals="0" placeholder="{{ t('sell') }} ({{ CURRENCY }})" required>
  <input type="number" name="quantity" placeholder="{{ t('quantity') }}" min="1" required>
  <button type="submit">{{ t('add') }}</button>
</form>

<!-- Language & Currency Panel -->
<div class="prefs-card card" style="padding:14px;margin-top:8px;">
  <h3 class="prefs-title">{{ t("lang_curr") }}</h3>

  <div class="form-row" style="gap:16px;">
    <!-- Language -->
    <form method="POST" action="{{ url_for('set_prefs') }}" class="prefs-form" id="lang-form" style="display:flex;gap:8px;align-items:center;">
      <label for="lang-select">{{ t("language") }}</label>
      <select name="lang" id="lang-select">
        <option value="en" {{ 'selected' if USER_LANG=='en' else '' }}>English</option>
        <option value="uz" {{ 'selected' if USER_LANG=='uz' else '' }}>Uzbek</option>
      </select>
      <div class="prefs-actions">
        <button type="submit">{{ t("save") }}</button>
      </div>
    </form>

    <!-- Currency -->
    <form action="{{ url_for('set_currency') }}" method="POST" class="prefs-form" id="currency-form" style="display:flex;gap:8px;align-items:center;">
      <label for="currency-select">{{ t("currency") }}</label>
      <select name="currency" id="currency-select">
        <option value="USD" {{ 'selected' if CURRENCY=='USD' else '' }}>USD ($)</option>
        <option value="AED" {{ 'selected' if CURRENCY=='AED' else '' }}>AED (د.إ)</option>
        <option value="UZS" {{ 'selected' if CURRENCY=='UZS' else '' }}>UZS (so'm)</option>
      </select>
      <div class="prefs-actions">
        <button type="submit">{{ t("save") }}</button>
        <button type="button" id="auto-detect">{{ t("auto_detect") }}</button>
      </div>
    </form>
  </div>

  <small style="display:block;margin-top:8px;">
    1 USD = {{ usd_to_aed | round(2) }} AED | {{ usd_to_uzs | round(0) }} UZS | 1.00 USD
  </small>
</div>

<script>
  // Auto-detect fills both selects; hit Save afterwards
  document.getElementById('auto-detect')?.addEventListener('click', async () => {
    try {
      const r = await fetch('/api/geo');
      const geo = await r.json();
      const country = geo.country || '';
      const langCode = (geo.languages || 'en').split(',')[0].split('-')[0];
      const currMap = { 'AE': 'AED', 'UZ': 'UZS', 'US': 'USD' };
      document.getElementById('lang-select').value = (langCode === 'uz' ? 'uz' : 'en');
      document.getElementById('currency-select').value = currMap[country] || 'USD';
    } catch (e) { console.warn('Geo detect failed', e); }
  });
</script>

<!-- Filters -->
<h2 class="filters-title">{{ t("filters") }}</h2>
<p class="hint">{{ t("low_stock_hint") }} {{ t("high_profit_hint") }}</p>

<form method="GET" action="{{ url_for('index') }}" class="form-row card" style="padding:12px;">
  <input type="text" name="search" placeholder="{{ t('search_item') }}..." value="{{ search_query }}">
  <select name="filter">
    <option value="">{{ t('filter') }} — </option>
    <option value="low_stock"  {% if selected_filter == 'low_stock'  %}selected{% endif %}>{{ t('low_stock') }} (≤ 5)</option>
    <option value="high_profit" {% if selected_filter == 'high_profit' %}selected{% endif %}>{{ t('high_profit') }}</option>
  </select>
  <input type="hidden" name="sort" value="{{ request.args.get('sort','') }}">
  <button type="submit">{{ t('apply') }}</button>
</form>

<!-- Inventory Table -->
<h2>{{ t("inventory") }}</h2>
<div class="table-wrap">
  {% set q = request.args.get('search','') %}
  {% set f = request.args.get('filter','') %}

  <div class="toolbar" style="padding:10px;">
    <button id="filterBtn" class="btn" aria-expanded="false" aria-haspopup="true" aria-controls="filterMenu">
      Filter / Sort
    </button>
    <div id="filterMenu" class="menu hidden" role="menu" aria-label="Inventory sort menu">
      <a class="menu-item" href="{{ url_for('index', sort='name_asc',  search=q, filter=f) }}">A → Z (Name)</a>
      <a class="menu-item" href="{{ url_for('index', sort='name_desc', search=q, filter=f) }}">Z → A (Name)</a>
      <hr class="menu-sep">
      <a class="menu-item" href="{{ url_for('index', sort='qty_desc',  search=q, filter=f) }}">Quantity: High → Low</a>
      <a class="menu-item" href="{{ url_for('index', sort='qty_asc',   search=q, filter=f) }}">Quantity: Low → High</a>
      <hr class="menu-sep">
      <a class="menu-item" href="{{ url_for('index', sort='price_desc', search=q, filter=f) }}">Price: High → Low</a>
      <a class="menu-item" href="{{ url_for('index', sort='price_asc',  search=q, filter=f) }}">Price: Low → High</a>
      <hr class="menu-sep">
      <a class="menu-item" href="{{ url_for('index', search=q, filter=f) }}">Reset sort</a>
    </div>
  </div>

  <style>
    .toolbar { position: relative; display:flex; gap:8px; align-items:center; margin-bottom:10px; }
    .menu.hidden { display:none; }
    #filterMenu { position:absolute; top:100%; left:0; margin-top:6px; z-index:5; padding:8px;
      border:1px solid var(--border); border-radius:10px; background:var(--card); box-shadow:0 8px 24px rgba(0,0,0,0.08); }
    #filterMenu .menu-item { display:block; padding:8px 12px; text-decoration:none; color:inherit; }
    #filterMenu .menu-item:hover { background:rgba(0,0,0,.06); }
    #filterMenu .menu-sep { margin:6px 0; border:none; border-top:1px solid var(--border); }
  </style>

  <script>
    (function(){
      const btn  = document.getElementById('filterBtn');
      const menu = document.getElementById('filterMenu');
      if (!btn || !menu) return;

      btn.addEventListener('click', (e)=>{
        e.stopPropagation();
        const hidden = menu.classList.toggle('hidden');
        btn.setAttribute('aria-expanded', String(!hidden));
      });

      document.addEventListener('click', (e)=>{
        if (!menu.contains(e.target) && e.target !== btn) {
          if (!menu.classList.contains('hidden')) {
            menu.classList.add('hidden');
            btn.setAttribute('aria-expanded', 'false');
          }
        }
      });

      document.addEventListener('keydown', (e)=>{
        if (e.key === 'Escape' && !menu.classList.contains('hidden')) {
          menu.classList.add('hidden');
          btn.setAttribute('aria-expanded', 'false');
        }
      });

      // Bold the active sort link
      const active = new URLSearchParams(location.search).get('sort') || '';
      document.querySelectorAll('#filterMenu .menu-item').forEach(a=>{
        if (active && a.href.includes(`sort=${active}`)) a.style.fontWeight = '700';
      });
    })();
  </script>

  <table id="inventoryTable" class="table">
    <thead>
      <tr>
        <th>#</th>
        <th>{{ t("item") }}</th>
        <th>{{ t("quantity") }}</th>
        <th>{{ t("buy") }} ({{ CURRENCY }})</th>
        <th>{{ t("sell") }} ({{ CURRENCY }})</th>
        <th>{{ t("profit") }} ({{ CURRENCY }})</th>
        <th>{{ t("action") }}</th>
      </tr>
    </thead>
    <tbody>
      {% for it in inventory %}
        <tr>
          <td>{{ loop.index }}</td>
          <td>{{ it[1] }}</td>
          <td>{{ it[4] | comma }}</td>
          <td>{{ (it[2] | ccy) | fmtmoney }}</td>
          <td>{{ (it[3] | ccy) | fmtmoney }}</td>
          <td>{{ (it[5] | ccy) | fmtmoney }}</td>
          <td>
            <a href="{{ url_for('edit_item', item_id=it[0]) }}" class="btn">Edit</a>
            <a href="{{ url_for('delete_item', item_id=it[0]) }}" class="btn btn-red" onclick="return confirm('Delete this item?')">Delete</a>
          </td>
        </tr>
      {% else %}
        <tr><td colspan="7" style="text-align:center; opacity:.7">No items found.</td></tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<!-- Sold Items (today) -->
<h2 class="mt-6">Sold Items</h2>
<p class="subtitle">Return puts the quantity back into Inventory and removes this sale from today.</p>

<div class="table-wrap">
  <table class="table">
    <thead>
      <tr>
        <th>#</th>
        <th>{{ t("item") }}</th>
        <th>{{ t("qty") }}</th>
        <th>{{ t("sell") }} ({{ CURRENCY }})</th>
        <th>{{ t("profit") }} ({{ CURRENCY }})</th>
        <th>{{ t("action") }}</th>
      </tr>
    </thead>
   <tbody>
  {% for it in inventory %}
    <tr>
      <td>{{ loop.index }}</td>
      <td>{{ it[1] }}</td>
      <td>{{ it[4] | comma }}</td>
      <td>{{ (it[2] | ccy) | fmtmoney }}</td>
      <td>{{ (it[3] | ccy) | fmtmoney }}</td>
      <td>{{ (it[5] | ccy) | fmtmoney }}</td>
      <td>
        <a href="{{ url_for('edit_item', item_id=it[0]) }}" class="btn">Edit</a>
        <a href="{{ url_for('delete_item', item_id=it[0]) }}" class="btn btn-red"
           onclick="return confirm('Delete this item?')">Delete</a>
      </td>
    </tr>
  {% endfor %}
</tbody>
  </table>
</div>

<!-- Stock Overview (fetches from /api/stock/overview) -->
<section class="chart-block card" style="padding:16px">
  <div class="row" style="display:flex;align-items:center;gap:12px;flex-wrap:wrap;justify-content:space-between">
    <h2 class="section-title" style="margin:0">Stock On Hand — Overview
      <span class="info" tabindex="0" data-tip="Bars show quantity per item; the line shows total stock value. Use search, sort, and Top N to focus. Scroll to zoom, drag to pan. Double-click to reset."></span>
    </h2>

    <div class="chart-controls" style="gap:8px">
      <input id="soh-search" type="search" placeholder="Search items…" style="padding:8px 12px;border:1px solid var(--border);border-radius:10px;background:var(--card);color:var(--text)">
      <label style="display:inline-flex;align-items:center;gap:6px">
        Sort
        <select id="soh-sort" style="padding:8px;border:1px solid var(--border);border-radius:10px;background:var(--card);color:var(--text)">
          <option value="qty_desc">Qty (high→low)</option>
          <option value="value_desc">Value (high→low)</option>
          <option value="profit_desc">Profit/unit (high→low)</option>
          <option value="name_asc">Name (A→Z)</option>
        </select>
      </label>
      <label style="display:inline-flex;align-items:center;gap:6px">
        Top N
        <input id="soh-topn" type="number" min="1" step="1" value="25" style="width:80px;padding:8px;border:1px solid var(--border);border-radius:10px;background:var(--card);color:var(--text)">
      </label>
      <label style="display:inline-flex;align-items:center;gap:6px">
        <input id="soh-hide-zero" type="checkbox" checked>
        Hide zero qty
      </label>
      <button id="soh-reset" class="btn btn-outline">Reset view</button>
    </div>
  </div>

  <div class="chart-card" style="height:420px;margin-top:10px">
    <canvas id="stockOverview"></canvas>
  </div>
</section>

<script>
const ctx = document.getElementById("stockOverview").getContext("2d");
const currency = "{{ CURRENCY }}";

let stockData = [];   // will be filled from API
let chart;

function renderChart(filtered) {
  if (chart) chart.destroy();
  chart = new Chart(ctx, {
    type: "bar",
    data: {
      labels: filtered.map(i => i.name),
      datasets: [
        {
          label: "Quantity",
          data: filtered.map(i => i.qty),
          backgroundColor: "rgba(59,130,246,0.5)",
          borderColor: "rgb(59,130,246)",
          borderWidth: 1,
          yAxisID: "y"
        },
        {
          label: `Stock Value (${currency})`,
          data: filtered.map(i => i.value),
          backgroundColor: "rgba(16,185,129,0.4)",
          borderColor: "rgb(16,185,129)",
          borderWidth: 1,
          type: "line",
          yAxisID: "y1"
        }
      ]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { position: "top" },
        tooltip: {
          mode: "index",
          intersect: false,
          callbacks: {
            label: function(ctx) {
              const value = ctx.parsed.y;
              if (ctx.dataset.label.includes("Value")) {
                return `${ctx.dataset.label}: ${value.toLocaleString()} ${currency}`;
              }
              return `${ctx.dataset.label}: ${value.toLocaleString()}`;
            }
          }
        }
      },
      interaction: { mode: "nearest", axis: "x", intersect: false },
      scales: {
        y: { beginAtZero: true, title: { display: true, text: "Quantity" } },
        y1: { beginAtZero: true, position: "right", title: { display: true, text: `Stock Value (${currency})` } }
      }
    }
  });
}

function applyFilters() {
  let data = [...stockData];
  const q = document.getElementById("soh-search").value.toLowerCase();
  const sort = document.getElementById("soh-sort").value;
  const topN = parseInt(document.getElementById("soh-topn").value) || data.length;
  const hideZero = document.getElementById("soh-hide-zero").checked;

  if (q) data = data.filter(i => i.name.toLowerCase().includes(q));
  if (hideZero) data = data.filter(i => i.qty > 0);

  switch (sort) {
    case "qty_desc": data.sort((a,b) => b.qty - a.qty); break;
    case "value_desc": data.sort((a,b) => b.value - a.value); break;
    case "profit_desc": data.sort((a,b) => (b.profit_per_unit || 0) - (a.profit_per_unit || 0)); break;
    case "name_asc": data.sort((a,b) => a.name.localeCompare(b.name)); break;
  }

  renderChart(data.slice(0, topN));
}

// Wire up controls
["soh-search","soh-sort","soh-topn","soh-hide-zero"].forEach(id =>
  document.getElementById(id)?.addEventListener("input", applyFilters)
);
document.getElementById("soh-reset")?.addEventListener("click", () => {
  document.getElementById("soh-search").value = "";
  document.getElementById("soh-sort").value = "qty_desc";
  document.getElementById("soh-topn").value = 25;
  document.getElementById("soh-hide-zero").checked = true;
  applyFilters();
});

// 🔌 Fetch data from your API (must be logged in; otherwise API returns 401)
fetch("/api/stock/overview")
  .then(r => r.ok ? r.json() : { items: [] })
  .then(d => {
    stockData = (d.items || []).map(i => ({
      name: i.name,
      qty: i.qty,
      value: i.value,
      profit_per_unit: i.profit_per
    }));
    applyFilters();
  })
  .catch(() => { stockData = []; applyFilters(); });
</script>


<!-- Live input money formatter -->
<script>
(function () {
  const inputs = document.querySelectorAll("[data-money]");
  function formatMoney(raw) {
    const digits = String(raw || "").replace(/[^\d]/g, "");
    if (!digits) return "";
    return digits.replace(/\B(?=(\d{3})+(?!\d))/g, ",");
  }
  function unformatMoney(s) { return String(s || "").replace(/,/g, ""); }
  inputs.forEach(inp => {
    if (inp.value) inp.value = formatMoney(inp.value);
    inp.addEventListener("input", () => {
      const start = inp.selectionStart || 0;
      const before = inp.value;
      inp.value = formatMoney(before);
      const diff = inp.value.length - before.length;
      const pos = Math.max(0, start + diff);
      try { inp.setSelectionRange(pos, pos); } catch(e) {}
    });
    inp.addEventListener("blur", () => { inp.value = formatMoney(inp.value); });
    if (inp.form) {
      inp.form.addEventListener("submit", () => { inp.value = unformatMoney(inp.value); });
    }
  });
})();
</script>

<!-- Export & Backup -->
<h2 class="export-title">{{ t("export_backup") }}</h2>
<p class="hint">
  <strong>{{ t("download_excel") }}</strong> — export your current inventory.<br>
  <strong>{{ t("backup_now") }}</strong> — create a ZIP with CSVs of your tables.
</p>

<div class="form-row card" style="padding:12px;">
  <a href="{{ url_for('export_excel') }}" class="btn btn-green">&#128202; {{ t("export_excel") }}</a>
  <a href="{{ url_for('admin_backup') }}" class="btn">&#128190; {{ t("backup_db") }}</a>
</div>

{% endblock %}
