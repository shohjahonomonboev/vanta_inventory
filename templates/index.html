{% extends "base.html" %}
{% block title %}Jasurbek Inventory Dashboard{% endblock %}
{% block content %}

<div class="logo-container">
  <img src="{{ url_for('static', filename='jasurbek_logo.png') }}" class="logo" alt="Jasurbek Logo">
</div>

<h1>Jasurbek Inventory System</h1>
<p class="subtitle">Welcome back, Commander.</p>

<div class="kpis">
  <div class="kpi kpi-green"><strong>Today's Revenue</strong><br> {{ CURRENCY }} {{ today_revenue | money }}</div>
  <div class="kpi kpi-blue"><strong>Today's Profit</strong><br> {{ CURRENCY }} {{ today_profit   | money }}</div>
</div>

<h2>Sell Item</h2>
<form action="{{ url_for('sell_item') }}" method="POST" class="form-row card">
  <select name="item_id" required id="sell-item-select">
    {% for item in inventory %}
      <option value="{{ item[0] }}">{{ item[1] }} — Stock: {{ item[4] }} — Sell: {{ item[3] | money }}</option>
    {% endfor %}
  </select>
  <input type="number" name="qty" placeholder="Qty" min="1" required>
  <input type="text" name="sell_price" id="sell-price" data-money data-decimals="0" placeholder="Sell Price ({{ CURRENCY }})" required>
  <button type="submit">Sell</button>
</form>

<script>
  // raw numbers (no commas) -> formatted by money-input script below
  const priceMap = { {% for item in inventory %}"{{ item[0] }}": {{ item[3] | float }} ,{% endfor %} };
  const sel = document.getElementById('sell-item-select');
  const priceInput = document.getElementById('sell-price');
  if (sel && priceInput) {
    const setPrice = () => {
      const v = priceMap[sel.value];
      if (v != null) {
        priceInput.value = String(Math.round(v));
        priceInput.dispatchEvent(new Event('input')); // format to 1,000,000
      } else {
        priceInput.value = "";
      }
    };
    sel.addEventListener('change', setPrice);
    setPrice();
  }
</script>

<h2>Add Item</h2>
<form action="{{ url_for('add_item') }}" method="POST" class="form-row card">
  <input type="text" name="name" placeholder="Item name" required>
  <input type="text" name="buying_price"  data-money data-decimals="0" placeholder="Buying price" required>
  <input type="text" name="selling_price" data-money data-decimals="0" placeholder="Selling price" required>
  <input type="number" name="quantity" placeholder="Quantity" required>
  <button type="submit">Add</button>
</form>

<form method="POST" action="{{ url_for('index') }}" class="form-row card">
  <input type="text" name="search" placeholder="Search item..." value="{{ search_query }}">
  <select name="filter">
    <option value="">-- Filter --</option>
    <option value="low_stock" {% if selected_filter == 'low_stock' %}selected{% endif %}>Low Stock (≤ 5)</option>
    <option value="high_profit" {% if selected_filter == 'high_profit' %}selected{% endif %}>High Profit (≥ 100 {{ CURRENCY }})</option>
  </select>
  <button type="submit">Apply</button>
</form>

<h2>Inventory</h2>
<div class="table-wrap">
<table>
  <thead>
    <tr>
      <th>#</th>
      <th><a href="{{ url_for('index', sort_by='name', direction='desc' if sort_by=='name' and direction=='asc' else 'asc') }}">Item</a></th>
      <th><a href="{{ url_for('index', sort_by='quantity', direction='desc' if sort_by=='quantity' and direction=='asc' else 'asc') }}">Quantity</a></th>
      <th>Buy ({{ CURRENCY }})</th>
      <th>Sell ({{ CURRENCY }})</th>
      <th><a href="{{ url_for('index', sort_by='profit', direction='desc' if sort_by=='profit' and direction=='asc' else 'asc') }}">Profit ({{ CURRENCY }})</a></th>
      <th>Action</th>
    </tr>
  </thead>
  <tbody>
    {% for item in inventory %}
    <tr>
      <td>{{ loop.index }}</td>
      <td>{{ item[1] }}</td>
      <td>{{ item[4] }}</td>
      <td>{{ item[2] | money }}</td>
      <td>{{ item[3] | money }}</td>
      <td>{{ item[5] | money }}</td>
      <td class="actions">
        <a href="{{ url_for('edit_item', item_id=item[0]) }}">✏️</a>
        <a href="{{ url_for('delete_item', item_id=item[0]) }}">❌</a>
      </td>
    </tr>
    {% endfor %}
  </tbody>
</table>
</div>

<h2>Insights</h2>
<div class="grid-2">
  <div class="chart-card"><canvas id="topProfitChart"></canvas></div>
  <div class="chart-card"><canvas id="lowStockChart"></canvas></div>
  <div class="chart-card"><canvas id="stockTrackerChart"></canvas></div>
  <div class="chart-card"><canvas id="salesChart"></canvas></div>
</div>

<script>
  const currency = "{{ CURRENCY }}";
  const css = name => getComputedStyle(document.documentElement).getPropertyValue(name).trim();
  const moneyFmt = (v) => `${currency} ` + Math.round(Number(v || 0)).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");

  function makeGradient(ctx, c1, c2){
    const g = ctx.createLinearGradient(0,0,0,300);
    g.addColorStop(0, c1); g.addColorStop(1, c2); return g;
  }

  function baseOptions(title){
    const textColor = css('--muted');
    const gridColor = css('--grid');
    return {
      responsive:true, maintainAspectRatio:false,
      plugins:{
        legend:{ labels:{ color:textColor, usePointStyle:true, pointStyle:'circle' } },
        title:{ display: !!title, text:title, color:textColor, padding:18 },
        tooltip:{ callbacks:{ label:(ctx)=> moneyFmt(ctx.parsed.y) } }
      },
      scales:{
        x:{ grid:{ display:false }, ticks:{ color:textColor } },
        y:{ grid:{ color:gridColor, drawBorder:false }, ticks:{ color:textColor, callback:v=>moneyFmt(v) } }
      },
      animation:{ duration:600, easing:'easeOutQuart' }
    };
  }

  function buildCharts(){
    const primary = css('--primary');
    const cyan = css('--cyan');

    (function(){
      const el = document.getElementById('topProfitChart'); if(!el) return;
      const ctx = el.getContext('2d');
      new Chart(ctx,{ type:'bar', data:{ labels: {{ top_profit_labels|tojson }}, datasets:[{
        label:'Top 5 Profitable Items', data: {{ top_profit_values|tojson }},
        backgroundColor: makeGradient(ctx, primary, 'rgba(96,165,250,.25)'), borderRadius: 10
      }]}, options: baseOptions('Top 5 Profitable Items') });
    })();

    (function(){
      const el = document.getElementById('lowStockChart'); if(!el) return;
      const ctx = el.getContext('2d');
      new Chart(ctx,{ type:'bar', data:{ labels: {{ low_stock_labels|tojson }}, datasets:[{
        label:'Lowest Stock (5)', data: {{ low_stock_values|tojson }},
        backgroundColor: makeGradient(ctx, cyan, 'rgba(34,211,238,.25)'), borderRadius: 10
      }]}, options: baseOptions('Lowest Stock (5)') });
    })();

    (function(){
      const el = document.getElementById('stockTrackerChart'); if(!el) return;
      const ctx = el.getContext('2d');
      new Chart(ctx,{ type:'line', data:{ labels: {{ stock_labels|tojson }}, datasets:[{
        label:'Stock Tracker', data: {{ stock_values|tojson }}, tension:.35, fill:true,
        backgroundColor: makeGradient(ctx, 'rgba(96,165,250,.25)', 'rgba(96,165,250,.05)'),
        borderColor: css('--primary'), pointRadius: 2
      }]}, options: baseOptions('Stock Tracker') });
    })();

    (function(){
      const el = document.getElementById('salesChart'); if(!el) return;
      const ctx = el.getContext('2d');
      new Chart(ctx,{ type:'line', data:{ labels: {{ sales_labels|tojson }}, datasets:[{
        label:`Daily Revenue (${currency})`, data: {{ sales_values|tojson }}, tension:.35, fill:true,
        backgroundColor: makeGradient(ctx, 'rgba(34,197,94,.20)', 'rgba(34,197,94,.05)'),
        borderColor: css('--green'), pointRadius: 2
      }]}, options: baseOptions('Revenue — Last 7 Days') });
    })();
  }

  buildCharts();
  document.addEventListener('vanta-theme-change', buildCharts);
</script>

<a href="/admin/backup" class="btn">Backup Now</a>

<p class="mt"><a href="{{ url_for('export_excel') }}" class="btn btn-green">⬇️ Download Excel</a></p>

<!-- Live input money formatter: turns 1000000 -> 1,000,000 while typing and strips commas on submit -->
<script>
(function () {
  const inputs = document.querySelectorAll("[data-money]");

  function formatMoney(raw) {
    const digits = String(raw || "").replace(/[^\d]/g, "");
    if (!digits) return "";
    return digits.replace(/\B(?=(\d{3})+(?!\d))/g, ",");
  }
  function unformatMoney(s) { return String(s || "").replace(/,/g, ""); }

  inputs.forEach(inp => {
    if (inp.value) inp.value = formatMoney(inp.value);

    inp.addEventListener("input", () => {
      const start = inp.selectionStart || 0;
      const before = inp.value;
      inp.value = formatMoney(before);
      const diff = inp.value.length - before.length;
      const pos = Math.max(0, start + diff);
      try { inp.setSelectionRange(pos, pos); } catch(e) {}
    });

    inp.addEventListener("blur", () => { inp.value = formatMoney(inp.value); });

    if (inp.form) {
      inp.form.addEventListener("submit", () => {
        inp.value = unformatMoney(inp.value);
      });
    }
  });
})();
</script>

{% endblock %}