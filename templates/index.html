{% extends "base.html" %}
{% block title %}Jasurbek Inventory Dashboard{% endblock %}
{% block content %}

<div class="logo-container">
  <img src="{{ url_for('static', filename='jasurbek_logo.png') }}" class="logo" alt="Jasurbek Logo">
</div>

<h1>Jasurbek Inventory System</h1>
<p class="subtitle">Welcome back, Commander.</p>

<div class="kpis">
  <div class="kpi kpi-green"><strong>Today's Revenue</strong><br> {{ CURRENCY }} {{ "%.2f"|format(today_revenue) }}</div>
  <div class="kpi kpi-blue"><strong>Today's Profit</strong><br> {{ CURRENCY }} {{ "%.2f"|format(today_profit) }}</div>
</div>

<h2>Sell Item</h2>
<form action="{{ url_for('sell_item') }}" method="POST" class="form-row card">
  <select name="item_id" required id="sell-item-select">
    {% for item in inventory %}
      <option value="{{ item[0] }}">{{ item[1] }} — Stock: {{ item[4] }} — Sell: {{ item[3] }}</option>
    {% endfor %}
  </select>
  <input type="number" name="qty" placeholder="Qty" min="1" required>
  <input type="number" step="0.01" name="sell_price" id="sell-price" placeholder="Sell Price ({{ CURRENCY }})" required>
  <button type="submit">Sell</button>
</form>

<script>
  const priceMap = { {% for item in inventory %}"{{ item[0] }}": {{ "%.2f"|format(item[3]) }},{% endfor %} };
  const sel = document.getElementById('sell-item-select');
  const priceInput = document.getElementById('sell-price');
  if (sel && priceInput) {
    const setPrice = () => { priceInput.value = priceMap[sel.value] ?? ""; };
    sel.addEventListener('change', setPrice); setPrice();
  }
</script>

<h2>Add Item</h2>
<form action="{{ url_for('add_item') }}" method="POST" class="form-row card">
  <input type="text" name="name" placeholder="Item name" required>
  <input type="number" step="0.01" name="buying_price" placeholder="Buying price" required>
  <input type="number" step="0.01" name="selling_price" placeholder="Selling price" required>
  <input type="number" name="quantity" placeholder="Quantity" required>
  <button type="submit">Add</button>
</form>

<form method="POST" action="{{ url_for('index') }}" class="form-row card">
  <input type="text" name="search" placeholder="Search item..." value="{{ search_query }}">
  <select name="filter">
    <option value="">-- Filter --</option>
    <option value="low_stock" {% if selected_filter == 'low_stock' %}selected{% endif %}>Low Stock (≤ 5)</option>
    <option value="high_profit" {% if selected_filter == 'high_profit' %}selected{% endif %}>High Profit (≥ 100 {{ CURRENCY }})</option>
  </select>
  <button type="submit">Apply</button>
</form>

<h2>Inventory</h2>
<div class="table-wrap">
<table>
  <thead>
    <tr>
      <th>#</th>
      <th><a href="{{ url_for('index', sort_by='name', direction='desc' if sort_by=='name' and direction=='asc' else 'asc') }}">Item</a></th>
      <th><a href="{{ url_for('index', sort_by='quantity', direction='desc' if sort_by=='quantity' and direction=='asc' else 'asc') }}">Quantity</a></th>
      <th>Buy ({{ CURRENCY }})</th>
      <th>Sell ({{ CURRENCY }})</th>
      <th><a href="{{ url_for('index', sort_by='profit', direction='desc' if sort_by=='profit' and direction=='asc' else 'asc') }}">Profit ({{ CURRENCY }})</a></th>
      <th>Action</th>
    </tr>
  </thead>
  <tbody>
    {% for item in inventory %}
    <tr>
      <td>{{ loop.index }}</td>
      <td>{{ item[1] }}</td>
      <td>{{ item[4] }}</td>
      <td>{{ item[2] }}</td>
      <td>{{ item[3] }}</td>
      <td>{{ item[5] }}</td>
      <td class="actions">
        <a href="{{ url_for('edit_item', item_id=item[0]) }}">✏️</a>
        <a href="{{ url_for('delete_item', item_id=item[0]) }}">❌</a>
      </td>
    </tr>
    {% endfor %}
  </tbody>
</table>
</div>

<h2>Insights</h2>
<div class="grid-2">
  <div class="chart-card"><canvas id="topProfitChart"></canvas></div>
  <div class="chart-card"><canvas id="lowStockChart"></canvas></div>
  <div class="chart-card"><canvas id="stockTrackerChart"></canvas></div>
  <div class="chart-card"><canvas id="salesChart"></canvas></div>
</div>

<script>
  const currency = "{{ CURRENCY }}";
  const fmt = new Intl.NumberFormat(undefined, { style:'currency', currencyDisplay:'narrowSymbol', currency: (currency || 'UZS') });
  const css = name => getComputedStyle(document.documentElement).getPropertyValue(name).trim();

  function makeGradient(ctx, c1, c2){
    const g = ctx.createLinearGradient(0,0,0,300);
    g.addColorStop(0, c1); g.addColorStop(1, c2); return g;
  }

  function baseOptions(title){
    const textColor = css('--muted');
    const gridColor = css('--grid');
    return {
      responsive:true, maintainAspectRatio:false,
      plugins:{
        legend:{ labels:{ color:textColor, usePointStyle:true, pointStyle:'circle' } },
        title:{ display: !!title, text:title, color:textColor, padding:18 }
      },
      scales:{
        x:{ grid:{ display:false }, ticks:{ color:textColor } },
        y:{ grid:{ color:gridColor, drawBorder:false }, ticks:{ color:textColor, callback:v=>fmt.format(v) } }
      },
      animation:{ duration:600, easing:'easeOutQuart' }
    };
  }

  function buildCharts(){
    const primary = css('--primary');
    const cyan = css('--cyan');

    (function(){
      const el = document.getElementById('topProfitChart'); if(!el) return;
      const ctx = el.getContext('2d');
      new Chart(ctx,{ type:'bar', data:{ labels: {{ top_profit_labels|tojson }}, datasets:[{
        label:'Top 5 Profitable Items', data: {{ top_profit_values|tojson }},
        backgroundColor: makeGradient(ctx, primary, 'rgba(96,165,250,.25)'), borderRadius: 10
      }]}, options: baseOptions('Top 5 Profitable Items') });
    })();

    (function(){
      const el = document.getElementById('lowStockChart'); if(!el) return;
      const ctx = el.getContext('2d');
      new Chart(ctx,{ type:'bar', data:{ labels: {{ low_stock_labels|tojson }}, datasets:[{
        label:'Lowest Stock (5)', data: {{ low_stock_values|tojson }},
        backgroundColor: makeGradient(ctx, cyan, 'rgba(34,211,238,.25)'), borderRadius: 10
      }]}, options: baseOptions('Lowest Stock (5)') });
    })();

    (function(){
      const el = document.getElementById('stockTrackerChart'); if(!el) return;
      const ctx = el.getContext('2d');
      new Chart(ctx,{ type:'line', data:{ labels: {{ stock_labels|tojson }}, datasets:[{
        label:'Stock Tracker', data: {{ stock_values|tojson }}, tension:.35, fill:true,
        backgroundColor: makeGradient(ctx, 'rgba(96,165,250,.25)', 'rgba(96,165,250,.05)'),
        borderColor: css('--primary'), pointRadius: 2
      }]}, options: baseOptions('Stock Tracker') });
    })();

    (function(){
      const el = document.getElementById('salesChart'); if(!el) return;
      const ctx = el.getContext('2d');
      new Chart(ctx,{ type:'line', data:{ labels: {{ sales_labels|tojson }}, datasets:[{
        label:`Daily Revenue (${currency})`, data: {{ sales_values|tojson }}, tension:.35, fill:true,
        backgroundColor: makeGradient(ctx, 'rgba(34,197,94,.20)', 'rgba(34,197,94,.05)'),
        borderColor: css('--green'), pointRadius: 2
      }]}, options: baseOptions('Revenue — Last 7 Days') });
    })();
  }

  buildCharts();
  document.addEventListener('vanta-theme-change', buildCharts);
</script>

<p class="mt"><a href="{{ url_for('export_excel') }}" class="btn btn-green">⬇️ Download Excel</a></p>

{% endblock %}