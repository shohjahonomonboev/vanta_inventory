{% extends "base.html" %}
{% block title %}{{ t("app_name") }}{% endblock %}
{% block content %}

<!-- Brand badge (optional) -->
<div class="logo-container" style="text-align:center;margin-bottom:8px;">
  <img src="{{ url_for('static', filename='jasurbek_logo.png') }}" class="logo" alt="Jasurbek Logo" style="max-height:64px;">
</div>

<h1>{{ t("app_name") }}</h1>
<p class="subtitle">{{ t("welcome_back") }}</p>

<!-- KPIs -->
<div class="kpis">
  <div class="kpi kpi-green">
    <strong>{{ t("todays_revenue") }}</strong>
    {{ today_revenue | ccy | fmtmoney }}
  </div>
  <div class="kpi kpi-blue">
    <strong>{{ t("todays_profit") }}</strong>
    {{ today_profit | ccy | fmtmoney }}
  </div>
</div>

<!-- Sell Item -->
<h2>{{ t("sell_item") }}</h2>
<form action="{{ url_for('sell_item') }}" method="POST" class="form-row card" style="padding:12px;">
  <select name="item_id" required id="sell-item-select" aria-label="{{ t('item') }}">
    {% for item in inventory %}
      {# item: (id, name, buy, sell, qty, profit, currency) #}
      <option value="{{ item[0] }}">
        {{ item[1] }} — {{ t('stock') }}: {{ item[4] }} — {{ t('sell') }}: {{ (item[3] | ccy) | fmtmoney }}
      </option>
    {% endfor %}
  </select>
  <input type="number" name="qty" placeholder="{{ t('qty') }}" min="1" required>
  <input type="text" name="sell_price" id="sell-price" data-money data-decimals="0" placeholder="{{ t('sell_price') }} ({{ CURRENCY }})" required>
  <button type="submit">{{ t('sell') }}</button>
</form>

<script>
  // Prefill sell price in current UI currency (server converted via | ccy)
  const priceMap = {
    {% for item in inventory -%}
      "{{ item[0] }}": {{ item[3] | ccy | float }},
    {%- endfor %}
  };
  (function(){
    const sel = document.getElementById('sell-item-select');
    const priceInput = document.getElementById('sell-price');
    if (!sel || !priceInput) return;
    function setPrice(){
      const v = priceMap[sel.value];
      priceInput.value = v != null ? String(Math.round(Number(v))) : "";
      priceInput.dispatchEvent(new Event('input'));
    }
    sel.addEventListener('change', setPrice);
    setPrice();
  })();
</script>

<!-- Add Item (with tooltip) -->
<h2 class="add-item-title">Add Item</h2>
<p class="hint">Prices you enter are in UI currency <strong>{{ CURRENCY }}</strong>. They’re stored internally in <strong>UZS</strong>.</p>
  {{ t("add_item") }}
  <span class="info-badge" tabindex="0" aria-label="Info">i</span>
  <span class="tooltip-box">
    {{ t("prices_in_ui_currency") if t("prices_in_ui_currency") else "Prices you enter are in" }}
    <strong>{{ CURRENCY }}</strong>. They’re stored internally in <strong>UZS</strong>.
  </span>
</h2>

<form action="{{ url_for('add_item') }}" method="POST" class="form-row card" style="padding:12px;">
  <input type="text" name="name" placeholder="{{ t('item') }}" required>
  <input type="text" name="buying_price"  data-money data-decimals="0" placeholder="{{ t('buy') }} ({{ CURRENCY }})" required>
  <input type="text" name="selling_price" data-money data-decimals="0" placeholder="{{ t('sell') }} ({{ CURRENCY }})" required>
  <input type="number" name="quantity" placeholder="{{ t('quantity') }}" min="1" required>
  <button type="submit">{{ t('add') }}</button>
</form>

<!-- Language & Currency Panel -->
<div class="prefs-card card" style="padding:14px;margin-top:8px;">
  <h3 class="prefs-title">{{ t("lang_curr") }}</h3>

  <div class="form-row" style="gap:16px;">
    <!-- Language -->
    <form method="POST" action="{{ url_for('set_prefs') }}" class="prefs-form" id="lang-form" style="display:flex;gap:8px;align-items:center;">
      <label for="lang-select">{{ t("language") }}</label>
      <select name="lang" id="lang-select">
        <option value="en" {{ 'selected' if USER_LANG=='en' else '' }}>English</option>
        <option value="uz" {{ 'selected' if USER_LANG=='uz' else '' }}>Uzbek</option>
      </select>
      <div class="prefs-actions">
        <button type="submit">{{ t("save") }}</button>
      </div>
    </form>

    <!-- Currency -->
    <form action="{{ url_for('set_currency') }}" method="POST" class="prefs-form" id="currency-form" style="display:flex;gap:8px;align-items:center;">
      <label for="currency-select">{{ t("currency") }}</label>
      <select name="currency" id="currency-select">
        <option value="USD" {{ 'selected' if CURRENCY=='USD' else '' }}>USD ($)</option>
        <option value="AED" {{ 'selected' if CURRENCY=='AED' else '' }}>AED (د.إ)</option>
        <option value="UZS" {{ 'selected' if CURRENCY=='UZS' else '' }}>UZS (so'm)</option>
      </select>
      <div class="prefs-actions">
        <button type="submit">{{ t("save") }}</button>
        <button type="button" id="auto-detect">{{ t("auto_detect") }}</button>
      </div>
    </form>
  </div>

  <small style="display:block;margin-top:8px;">
    1 USD = {{ usd_to_aed | round(2) }} AED | {{ usd_to_uzs | round(0) }} UZS | 1.00 USD
  </small>
</div>

<script>
  // Auto-detect fills both selects; hit Save afterwards
  document.getElementById('auto-detect')?.addEventListener('click', async () => {
    try {
      const r = await fetch('/api/geo');
      const geo = await r.json();
      const country = geo.country || '';
      const langCode = (geo.languages || 'en').split(',')[0].split('-')[0];
      const currMap = { 'AE': 'AED', 'UZ': 'UZS', 'US': 'USD' };
      document.getElementById('lang-select').value = (langCode === 'uz' ? 'uz' : 'en');
      document.getElementById('currency-select').value = currMap[country] || 'USD';
    } catch (e) { console.warn('Geo detect failed', e); }
  });
</script>

<!-- Filters -->
<h2 class="filters-title">{{ t("filters") }}</h2>
<p class="hint">{{ t("low_stock_hint") }} {{ t("high_profit_hint") }}</p>

<form method="GET" action="{{ url_for('index') }}" class="form-row card" style="padding:12px;">
  <input type="text" name="search" placeholder="{{ t('search_item') }}..." value="{{ search_query }}">
  <select name="filter">
    <option value="">{{ t('filter') }} — </option>
    <option value="low_stock"  {% if selected_filter == 'low_stock'  %}selected{% endif %}>{{ t('low_stock') }} (≤ 5)</option>
    <option value="high_profit" {% if selected_filter == 'high_profit' %}selected{% endif %}>{{ t('high_profit') }}</option>
  </select>
  <!-- preserve current sort -->
  <input type="hidden" name="sort" value="{{ request.args.get('sort','') }}">
  <button type="submit">{{ t('apply') }}</button>
</form>

<!-- Inventory Table -->
<h2>{{ t("inventory") }}</h2>
<div class="table-wrap">
  {% set q = request.args.get('search','') %}
  {% set f = request.args.get('filter','') %}

  <div class="toolbar" style="padding:10px;">
    <button id="filterBtn" class="btn" aria-expanded="false" aria-haspopup="true" aria-controls="filterMenu">
      Filter / Sort
    </button>
    <div id="filterMenu" class="menu hidden" role="menu" aria-label="Inventory sort menu">
      <a class="menu-item" href="{{ url_for('index', sort='name_asc',  search=q, filter=f) }}">A → Z (Name)</a>
      <a class="menu-item" href="{{ url_for('index', sort='name_desc', search=q, filter=f) }}">Z → A (Name)</a>
      <hr class="menu-sep">
      <a class="menu-item" href="{{ url_for('index', sort='qty_desc',  search=q, filter=f) }}">Quantity: High → Low</a>
      <a class="menu-item" href="{{ url_for('index', sort='qty_asc',   search=q, filter=f) }}">Quantity: Low → High</a>
      <hr class="menu-sep">
      <a class="menu-item" href="{{ url_for('index', sort='price_desc', search=q, filter=f) }}">Price: High → Low</a>
      <a class="menu-item" href="{{ url_for('index', sort='price_asc',  search=q, filter=f) }}">Price: Low → High</a>
      <hr class="menu-sep">
      <a class="menu-item" href="{{ url_for('index', search=q, filter=f) }}">Reset sort</a>
    </div>
  </div>

  <style>
    .toolbar { position: relative; display:flex; gap:8px; align-items:center; margin-bottom:10px; }
    .menu.hidden { display:none; }
    #filterMenu { position:absolute; top:100%; left:0; margin-top:6px; z-index:5; padding:8px;
      border:1px solid var(--border); border-radius:10px; background:var(--card); box-shadow:0 8px 24px rgba(0,0,0,0.08); }
    #filterMenu .menu-item { display:block; padding:8px 12px; text-decoration:none; color:inherit; }
    #filterMenu .menu-item:hover { background:rgba(0,0,0,.06); }
    #filterMenu .menu-sep { margin:6px 0; border:none; border-top:1px solid var(--border); }
  </style>

  <script>
    (function(){
      const btn  = document.getElementById('filterBtn');
      const menu = document.getElementById('filterMenu');
      if (!btn || !menu) return;

      btn.addEventListener('click', (e)=>{
        e.stopPropagation();
        const hidden = menu.classList.toggle('hidden');
        btn.setAttribute('aria-expanded', String(!hidden));
      });

      document.addEventListener('click', (e)=>{
        if (!menu.contains(e.target) && e.target !== btn) {
          if (!menu.classList.contains('hidden')) {
            menu.classList.add('hidden');
            btn.setAttribute('aria-expanded', 'false');
          }
        }
      });

      document.addEventListener('keydown', (e)=>{
        if (e.key === 'Escape' && !menu.classList.contains('hidden')) {
          menu.classList.add('hidden');
          btn.setAttribute('aria-expanded', 'false');
        }
      });

      // Bold the active sort link
      const active = new URLSearchParams(location.search).get('sort') || '';
      document.querySelectorAll('#filterMenu .menu-item').forEach(a=>{
        if (active && a.href.includes(`sort=${active}`)) a.style.fontWeight = '700';
      });
    })();
  </script>

  <table id="inventoryTable" class="table">
    <thead>
      <tr>
        <th>#</th>
        <th>{{ t("item") }}</th>
        <th>{{ t("quantity") }}</th>
        <th>{{ t("buy") }} ({{ CURRENCY }})</th>
        <th>{{ t("sell") }} ({{ CURRENCY }})</th>
        <th>{{ t("profit") }} ({{ CURRENCY }})</th>
        <th>{{ t("action") }}</th>
      </tr>
    </thead>
    <tbody>
      {% for it in inventory %}
        {% set row_profit = (it[3] - it[2]) * (it[4] or 0) %}
        <tr>
          <td>{{ loop.index }}</td>
          <td data-col="name">{{ it[1] }}</td>
          <td data-col="qty">{{ it[4] }}</td>
          <td data-label="{{ t('buy') }} ({{ CURRENCY }})">{{ it[2] | ccy | fmtmoney }}</td>
          <td data-col="price" data-label="{{ t('sell') }} ({{ CURRENCY }})">{{ it[3] | ccy | fmtmoney }}</td>
          <td data-label="{{ t('profit') }} ({{ CURRENCY }})">{{ row_profit | ccy | fmtmoney }}</td>
          <td class="actions">
            <a href="{{ url_for('edit_item', item_id=it[0]) }}" title="Edit">&#9998;</a>
            <a href="{{ url_for('delete_item', item_id=it[0]) }}" onclick="return confirm('Delete item?')" title="Delete">&#10060;</a>
          </td>
        </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<!-- Sold Items (today) -->
<h2 class="mt-6">Sold Items</h2>
<p class="subtitle">Return puts the quantity back into Inventory and removes this sale from today.</p>

<div class="table-wrap">
  <table class="table">
    <thead>
      <tr>
        <th>#</th>
        <th>{{ t("item") }}</th>
        <th>{{ t("qty") }}</th>
        <th>{{ t("sell") }} ({{ CURRENCY }})</th>
        <th>{{ t("profit") }} ({{ CURRENCY }})</th>
        <th>{{ t("action") }}</th>
      </tr>
    </thead>
    <tbody>
      {% for s in sales_today %}
        <tr>
          <td>{{ loop.index }}</td>
          <td>{{ s[2] }}</td>
          <td>{{ s[3] }}</td>
          <td>{{ s[4] | ccy | fmtmoney }}</td>
          <td>{{ s[5] | ccy | fmtmoney }}</td>
          <td class="actions">
            <form method="POST" action="{{ url_for('return_sale', sale_id=s[0]) }}" style="display:inline">
              <button class="btn btn-icon" title="Return">&#8617;</button>
            </form>
            <form method="POST" action="{{ url_for('delete_sale', sale_id=s[0]) }}" style="display:inline" onsubmit="return confirm('Delete sale record?')">
              <button class="btn btn-icon" title="Delete">&#128465;</button>
            </form>
          </td>
        </tr>
      {% else %}
        <tr><td colspan="6" style="text-align:center; opacity:.7">No sales yet today.</td></tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<!-- Insights -->
<h2>{{ t("insights") }}</h2>
<div class="grid-2">
  <div class="chart-card"><canvas id="topProfitChart"></canvas></div>
  <div class="chart-card"><canvas id="lowStockChart"></canvas></div>
  <div class="chart-card"><canvas id="stockTrackerChart"></canvas></div>
  <div class="chart-card"><canvas id="salesChart"></canvas></div>
</div>

<script>
  const currency = "{{ CURRENCY }}";
  const locale = "{{ 'en-US' if USER_LANG == 'en' else 'uz-UZ' }}";
  const numberFmt = new Intl.NumberFormat(locale, { style: 'currency', currency });
  const css = name => getComputedStyle(document.documentElement).getPropertyValue(name).trim();
  const moneyFmt = (v) => numberFmt.format(Number(v || 0));

  function makeGradient(ctx, c1, c2){
    const g = ctx.createLinearGradient(0,0,0,300);
    g.addColorStop(0, c1); g.addColorStop(1, c2); return g;
  }

  function baseOptions(title){
    const textColor = css('--muted');
    const gridColor = css('--grid');
    return {
      responsive:true, maintainAspectRatio:false,
      plugins:{
        legend:{ labels:{ color:textColor, usePointStyle:true, pointStyle:'circle' } },
        title:{ display: !!title, text:title, color:textColor, padding:18 },
        tooltip:{ callbacks:{ label:(ctx)=> moneyFmt(ctx.parsed.y) } }
      },
      scales:{
        x:{ grid:{ display:false }, ticks:{ color:textColor } },
        y:{ grid:{ color:gridColor, drawBorder:false }, ticks:{ color:textColor, callback:v=>moneyFmt(v) } }
      },
      animation:{ duration:600, easing:'easeOutQuart' }
    };
  }

  function buildCharts(){
    const primary = css('--primary');
    const cyan = css('--cyan');

    {% if top_profit_labels is defined and top_profit_values is defined %}
    (function(){
      const el = document.getElementById('topProfitChart'); if(!el) return;
      const ctx = el.getContext('2d');
      new Chart(ctx,{ type:'bar', data:{ labels: {{ top_profit_labels|tojson }}, datasets:[{
        label:'{{ t("top_profit_label") }}', data: {{ top_profit_values|tojson }},
        backgroundColor: makeGradient(ctx, primary, 'rgba(96,165,250,.25)'), borderRadius: 10
      }]}, options: baseOptions('{{ t("top_profit_title") }}') });
    })();
    {% endif %}

    {% if low_stock_labels is defined and low_stock_values is defined %}
    (function(){
      const el = document.getElementById('lowStockChart'); if(!el) return;
      const ctx = el.getContext('2d');
      new Chart(ctx,{ type:'bar', data:{ labels: {{ low_stock_labels|tojson }}, datasets:[{
        label:'{{ t("low_stock_label") }}', data: {{ low_stock_values|tojson }},
        backgroundColor: makeGradient(ctx, cyan, 'rgba(34,211,238,.25)'), borderRadius: 10
      }]}, options: baseOptions('{{ t("low_stock_title") }}') });
    })();
    {% endif %}

    (function(){
      const el = document.getElementById('stockTrackerChart'); if(!el) return;
      const ctx = el.getContext('2d');
      new Chart(ctx,{ type:'line', data:{ labels: {{ stock_labels|tojson }}, datasets:[{
        label:'{{ t("stock_tracker_label") }}', data: {{ stock_values|tojson }}, tension:.35, fill:true,
        backgroundColor: makeGradient(ctx, 'rgba(96,165,250,.25)', 'rgba(96,165,250,.05)'),
        borderColor: css('--primary'), pointRadius: 2
      }]}, options: baseOptions('{{ t("stock_tracker_title") }}') });
    })();

    (function(){
      const el = document.getElementById('salesChart'); if(!el) return;
      const ctx = el.getContext('2d');
      new Chart(ctx,{ type:'line', data:{ labels: {{ sales_labels|tojson }}, datasets:[{
        label:'{{ t("daily_revenue_label") }} ({{ CURRENCY }})', data: {{ sales_values|tojson }}, tension:.35, fill:true,
        backgroundColor: makeGradient(ctx, 'rgba(34,197,94,.20)', 'rgba(34,197,94,.05)'),
        borderColor: css('--green'), pointRadius: 2
      }]}, options: baseOptions('{{ t("revenue_7d_title") }}') });
    })();
  }

  buildCharts();
  document.addEventListener('vanta-theme-change', buildCharts);
</script>

<!-- Live input money formatter -->
<script>
(function () {
  const inputs = document.querySelectorAll("[data-money]");
  function formatMoney(raw) {
    const digits = String(raw || "").replace(/[^\d]/g, "");
    if (!digits) return "";
    return digits.replace(/\B(?=(\d{3})+(?!\d))/g, ",");
  }
  function unformatMoney(s) { return String(s || "").replace(/,/g, ""); }
  inputs.forEach(inp => {
    if (inp.value) inp.value = formatMoney(inp.value);
    inp.addEventListener("input", () => {
      const start = inp.selectionStart || 0;
      const before = inp.value;
      inp.value = formatMoney(before);
      const diff = inp.value.length - before.length;
      const pos = Math.max(0, start + diff);
      try { inp.setSelectionRange(pos, pos); } catch(e) {}
    });
    inp.addEventListener("blur", () => { inp.value = formatMoney(inp.value); });
    if (inp.form) {
      inp.form.addEventListener("submit", () => { inp.value = unformatMoney(inp.value); });
    }
  });
})();
</script>

<!-- Export & Backup -->
<h2 class="export-title">{{ t("export_backup") }}</h2>
<p class="hint">
  <strong>{{ t("download_excel") }}</strong> — export your current inventory.  
  <strong>{{ t("backup_now") }}</strong> — create a ZIP with CSVs of your tables.
</p>

<div class="form-row card" style="padding:12px;">
  <a href="{{ url_for('export_excel') }}" class="btn btn-green">&#128202; {{ t("export_excel") }}</a>
  <a href="{{ url_for('admin_backup') }}" class="btn">&#128190; {{ t("backup_db") }}</a>
</div>

{% endblock %}
