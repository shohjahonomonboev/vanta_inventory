{% extends "base.html" %}
{% block title %}{{ t("app_name") }}{% endblock %}
{% block content %}

<div class="logo-container">
  <img src="{{ url_for('static', filename='jasurbek_logo.png') }}" class="logo" alt="Jasurbek Logo">
</div>

<h1>{{ t("app_name") }}</h1>
<p class="subtitle">Welcome back, Commander.</p>

<!-- KPIs -->
<div class="kpis">
  <div class="kpi kpi-green">
    <strong>{{ t("todays_revenue") }}</strong><br>
    {{ today_revenue | ccy | fmtmoney }}
  </div>
  <div class="kpi kpi-blue">
    <strong>{{ t("todays_profit") }}</strong><br>
    {{ today_profit | ccy | fmtmoney }}
  </div>
</div>

<!-- Sell Item -->
<h2>{{ t("sell_item") }}</h2>
<form action="{{ url_for('sell_item') }}" method="POST" class="form-row card">
  <select name="item_id" required id="sell-item-select">
    {% for item in inventory %}
      {# item: (id, name, buying_price, selling_price, quantity, profit, currency) #}
      <option value="{{ item[0] }}">
        {{ item[1] }} — {{ t('stock') }}: {{ item[4] }} — {{ t('sell') }}: {{ (item[3] | ccy) | fmtmoney }}
      </option>
    {% endfor %}
  </select>
  <input type="number" name="qty" placeholder="{{ t('qty') }}" min="1" required>
  <input type="text" name="sell_price" id="sell-price" data-money data-decimals="0" placeholder="{{ t('sell_price') }} ({{ CURRENCY }})" required>
  <button type="submit">{{ t('sell') }}</button>
</form>

<script>
  // Prefill sell price in current UI currency (server converted via | ccy)
  const priceMap = {
    {% for item in inventory -%}
      "{{ item[0] }}": {{ item[3] | ccy | float }},
    {%- endfor %}
  };
  (function(){
    const sel = document.getElementById('sell-item-select');
    const priceInput = document.getElementById('sell-price');
    if (!sel || !priceInput) return;
    function setPrice(){
      const v = priceMap[sel.value];
      priceInput.value = v != null ? String(Math.round(Number(v))) : "";
      priceInput.dispatchEvent(new Event('input'));
    }
    sel.addEventListener('change', setPrice);
    setPrice();
  })();
</script>

<!-- Add Item -->
<h2 class="add-item-title">{{ t("add_item") }}</h2>
<p class="hint">
  Prices you enter are in <strong>{{ CURRENCY }}</strong>, stored internally in <strong>UZS</strong>.
</p>

<form action="{{ url_for('add_item') }}" method="POST" class="form-row card">
  <input type="text" name="name" placeholder="{{ t('item') }}" required>
  <input type="text" name="buying_price"  data-money data-decimals="0" placeholder="{{ t('buy') }}" required>
  <input type="text" name="selling_price" data-money data-decimals="0" placeholder="{{ t('sell') }}" required>
  <input type="number" name="quantity" placeholder="{{ t('quantity') }}" required>
  <button type="submit">{{ t('add') }}</button>
</form>



<!-- Filters (no extra hint text) -->
<h2 class="filters-title">{{ t("filters") }}</h2>

<form method="GET" action="{{ url_for('index') }}" class="form-row card">
  <input type="text" name="search" placeholder="{{ t('search_item') }}..." value="{{ search_query }}">
  <select name="filter">
    <option value="">{{ t('filter') }} — </option>
    <option value="low_stock"  {% if selected_filter == 'low_stock'  %}selected{% endif %}>{{ t('low_stock') }} (≤ 5)</option>
    <option value="high_profit" {% if selected_filter == 'high_profit' %}selected{% endif %}>{{ t('high_profit') }}</option>
  </select>
  <button type="submit">{{ t('apply') }}</button>
</form>



<!-- Language & Currency Panel -->
<div class="prefs-card">
  <h3 class="prefs-title">{{ t("lang_curr") }}</h3>

  <!-- Language form -->
  <form method="POST" action="{{ url_for('set_prefs') }}" class="prefs-form" id="lang-form">
    <label>{{ t("language") }}</label>
    <select name="lang" id="lang-select">
      <option value="en" {{ 'selected' if USER_LANG=='en' else '' }}>English</option>
      <option value="uz" {{ 'selected' if USER_LANG=='uz' else '' }}>Uzbek</option>
    </select>
    <div class="prefs-actions">
      <button type="submit">{{ t("save") }}</button>
    </div>
  </form>

  <!-- Currency form -->
  <form action="{{ url_for('set_currency') }}" method="POST" class="prefs-form" id="currency-form">
    <label>{{ t("currency") }}</label>
    <select name="currency" id="currency-select">
      <option value="USD" {{ 'selected' if CURRENCY=='USD' else '' }}>USD ($)</option>
      <option value="AED" {{ 'selected' if CURRENCY=='AED' else '' }}>AED (د.إ)</option>
      <option value="UZS" {{ 'selected' if CURRENCY=='UZS' else '' }}>UZS (so'm)</option>
    </select>
    <div class="prefs-actions">
      <button type="submit">{{ t("save") }}</button>
      <button type="button" id="auto-detect">{{ t("auto_detect") }}</button>
    </div>
  </form>

  <!-- Server-rendered live FX (no JS fetch needed) -->
  <small>
    1 USD = {{ usd_to_aed | round(2) }} AED | {{ usd_to_uzs | round(0) }} UZS | 1.00 USD
  </small>
</div>

<!-- Auto-detect fills both selects; you can hit Save afterwards -->
<script>
  document.getElementById('auto-detect')?.addEventListener('click', async () => {
    try {
      const r = await fetch('/api/geo');
      const geo = await r.json();
      const country = geo.country || '';
      const langCode = (geo.languages || 'en').split(',')[0].split('-')[0];
      const currMap = { 'AE': 'AED', 'UZ': 'UZS', 'US': 'USD' };
      document.getElementById('lang-select').value = (langCode === 'uz' ? 'uz' : 'en');
      document.getElementById('currency-select').value = currMap[country] || 'USD';
    } catch (e) { console.warn('Geo detect failed', e); }
  });
</script>

<!-- Inventory Table -->
<h2>{{ t("inventory") }}</h2>
<div class="table-wrap">
<table>
  <thead>
    <tr>
      <th>#</th>
      <th>{{ t("item") }}</th>
      <th>{{ t("quantity") }}</th>
      <th>Sotib olish ({{ CURRENCY }})</th>
      <th>Sotish ({{ CURRENCY }})</th>
      <th>Foyda ({{ CURRENCY }})</th>
      <th>{{ t("action") }}</th>
    </tr>
  </thead>
  <tbody>
    {% for item in inventory %}
      {% set row_profit = (item[3] - item[2]) * item[4] %}
      <tr>
        <td>{{ loop.index }}</td>
        <td>{{ item[1] }}</td>
        <td>{{ item[4] }}</td>
        <td data-label="Sotib olish ({{ CURRENCY }})">{{ item[2] | ccy | fmtmoney }}</td>
        <td data-label="Sotish ({{ CURRENCY }})">{{ item[3] | ccy | fmtmoney }}</td>
        <td data-label="Foyda ({{ CURRENCY }})">{{ row_profit | ccy | fmtmoney }}</td>
        <td class="actions">
          <a href="{{ url_for('edit_item', item_id=item[0]) }}">✏️</a>
          <a href="{{ url_for('delete_item', item_id=item[0]) }}">❌</a>
        </td>
      </tr>
    {% endfor %}
  </tbody>
</table>
</div>

<!-- Insights -->
<h2>{{ t("insights") }}</h2>
<div class="grid-2">
  <div class="chart-card"><canvas id="topProfitChart"></canvas></div>
  <div class="chart-card"><canvas id="lowStockChart"></canvas></div>
  <div class="chart-card"><canvas id="stockTrackerChart"></canvas></div>
  <div class="chart-card"><canvas id="salesChart"></canvas></div>
</div>

<script>
  const currency = "{{ CURRENCY }}";
  const locale = "{{ 'en-US' if USER_LANG == 'en' else 'uz-UZ' }}";
  const numberFmt = new Intl.NumberFormat(locale, { style: 'currency', currency });
  const css = name => getComputedStyle(document.documentElement).getPropertyValue(name).trim();
  const moneyFmt = (v) => numberFmt.format(Number(v || 0));

  function makeGradient(ctx, c1, c2){
    const g = ctx.createLinearGradient(0,0,0,300);
    g.addColorStop(0, c1); g.addColorStop(1, c2); return g;
  }

  function baseOptions(title){
    const textColor = css('--muted');
    const gridColor = css('--grid');
    return {
      responsive:true, maintainAspectRatio:false,
      plugins:{
        legend:{ labels:{ color:textColor, usePointStyle:true, pointStyle:'circle' } },
        title:{ display: !!title, text:title, color:textColor, padding:18 },
        tooltip:{ callbacks:{ label:(ctx)=> moneyFmt(ctx.parsed.y) } }
      },
      scales:{
        x:{ grid:{ display:false }, ticks:{ color:textColor } },
        y:{ grid:{ color:gridColor, drawBorder:false }, ticks:{ color:textColor, callback:v=>moneyFmt(v) } }
      },
      animation:{ duration:600, easing:'easeOutQuart' }
    };
  }

  function buildCharts(){
    const primary = css('--primary');
    const cyan = css('--cyan');

    {% if top_profit_labels is defined and top_profit_values is defined %}
    (function(){
      const el = document.getElementById('topProfitChart'); if(!el) return;
      const ctx = el.getContext('2d');
      new Chart(ctx,{ type:'bar', data:{ labels: {{ top_profit_labels|tojson }}, datasets:[{
        label:'Top 5 Profitable Items', data: {{ top_profit_values|tojson }},
        backgroundColor: makeGradient(ctx, primary, 'rgba(96,165,250,.25)'), borderRadius: 10
      }]}, options: baseOptions('Top 5 Profitable Items') });
    })();
    {% endif %}

    {% if low_stock_labels is defined and low_stock_values is defined %}
    (function(){
      const el = document.getElementById('lowStockChart'); if(!el) return;
      const ctx = el.getContext('2d');
      new Chart(ctx,{ type:'bar', data:{ labels: {{ low_stock_labels|tojson }}, datasets:[{
        label:'Lowest Stock (5)', data: {{ low_stock_values|tojson }},
        backgroundColor: makeGradient(ctx, cyan, 'rgba(34,211,238,.25)'), borderRadius: 10
      }]}, options: baseOptions('Lowest Stock (5)') });
    })();
    {% endif %}

    (function(){
      const el = document.getElementById('stockTrackerChart'); if(!el) return;
      const ctx = el.getContext('2d');
      new Chart(ctx,{ type:'line', data:{ labels: {{ stock_labels|tojson }}, datasets:[{
        label:'Stock Tracker', data: {{ stock_values|tojson }}, tension:.35, fill:true,
        backgroundColor: makeGradient(ctx, 'rgba(96,165,250,.25)', 'rgba(96,165,250,.05)'),
        borderColor: css('--primary'), pointRadius: 2
      }]}, options: baseOptions('Stock Tracker') });
    })();

    (function(){
      const el = document.getElementById('salesChart'); if(!el) return;
      const ctx = el.getContext('2d');
      new Chart(ctx,{ type:'line', data:{ labels: {{ sales_labels|tojson }}, datasets:[{
        label:`Daily Revenue (${currency})`, data: {{ sales_values|tojson }}, tension:.35, fill:true,
        backgroundColor: makeGradient(ctx, 'rgba(34,197,94,.20)', 'rgba(34,197,94,.05)'),
        borderColor: css('--green'), pointRadius: 2
      }]}, options: baseOptions('Revenue — Last 7 Days') });
    })();
  }

  buildCharts();
  document.addEventListener('vanta-theme-change', buildCharts);
</script>


<!-- Live input money formatter -->
<script>
(function () {
  const inputs = document.querySelectorAll("[data-money]");

  function formatMoney(raw) {
    const digits = String(raw || "").replace(/[^\d]/g, "");
    if (!digits) return "";
    return digits.replace(/\B(?=(\d{3})+(?!\d))/g, ",");
  }
  function unformatMoney(s) { return String(s || "").replace(/,/g, ""); }

  inputs.forEach(inp => {
    if (inp.value) inp.value = formatMoney(inp.value);

    inp.addEventListener("input", () => {
      const start = inp.selectionStart || 0;
      const before = inp.value;
      inp.value = formatMoney(before);
      const diff = inp.value.length - before.length;
      const pos = Math.max(0, start + diff);
      try { inp.setSelectionRange(pos, pos); } catch(e) {}
    });

    inp.addEventListener("blur", () => { inp.value = formatMoney(inp.value); });

    if (inp.form) {
      inp.form.addEventListener("submit", () => {
        inp.value = unformatMoney(inp.value);
      });
    }
  });
})();
</script>

<!-- Export & Backup -->
<h2 class="export-title">{{ t("export_backup") }}</h2>
<p class="hint">
  <strong>Export Excel</strong> downloads your current inventory. 
  <strong>Backup DB</strong> creates a ZIP with CSVs of your tables.
</p>

<div class="form-row card">
  <a href="{{ url_for('export_excel') }}" class="btn btn-green">📊 {{ t("export_excel") }}</a>
  <a href="{{ url_for('admin_backup') }}" class="btn">💾 {{ t("backup_db") }}</a>
</div>



{% endblock %}

