{% extends "base.html" %}
{% block title %}{{ t("app_name") }}{% endblock %}
{% block content %}

<div class="logo-container a-down" style="text-align:center;margin-bottom:8px;">
  <img src="{{ url_for('static', filename='jasurbek_logo.png') }}" class="logo" alt="Jasurbek Logo" style="max-height:64px;">
</div>

<h1 class="a-down">{{ t("app_name") }}</h1>
<p class="subtitle a-up">{{ t("welcome_back") }}</p>

<!-- KPIs -->
<div class="kpis stagger">
  <div class="kpi kpi-green card a-up" data-tilt>
    <strong>{{ t("todays_revenue") }}</strong>
    {{ today_revenue | ccy | fmtmoney }}
  </div>
  <div class="kpi kpi-blue card a-up" data-tilt>
    <strong>{{ t("todays_profit") }}</strong>
    {{ today_profit | ccy | fmtmoney }}
  </div>
</div>

<!-- Date window -->
<form method="GET" action="{{ url_for('index') }}" class="form-row card a-up" style="padding:12px; gap:8px; align-items:center;">
  <label>From <input type="date" name="from" value="{{ selected_from }}"></label>
  <label>To   <input type="date" name="to"   value="{{ selected_to }}"></label>
  <input type="hidden" name="search" value="{{ search_query }}">
  <input type="hidden" name="filter" value="{{ selected_filter }}">
  <input type="hidden" name="sort"   value="{{ request.args.get('sort','') }}">
  <div class="btn-row">
    <button type="submit" class="btn btn-primary btn-sm" data-lock>{{ t('apply') or 'Apply' }}</button>
    <a class="btn btn-ghost btn-sm" href="{{ url_for('index') }}">{{ t('reset') or 'Reset' }}</a>
  </div>
</form>

<!-- Sell Item -->
<h2 class="a-down">{{ t("sell_item") }}</h2>
<form action="{{ url_for('sell_item') }}" method="POST" class="form-row card a-up" style="padding:12px;">
  <input type="hidden" name="_csrf" value="{{ CSRF_TOKEN }}">
  <select name="item_id" required id="sell-item-select" aria-label="{{ t('item') }}">
    {% for item in inventory %}
      <option value="{{ item[0] }}">
        {{ item[1] }} — {{ t('stock') }}: {{ item[4] }} — {{ t('sell') }}: {{ (item[3] | ccy) | fmtmoney }}
      </option>
    {% endfor %}
  </select>
  <input type="number" name="qty" placeholder="{{ t('qty') }}" min="1" required>
  <input type="text" name="sell_price" id="sell-price" data-money data-decimals="0" placeholder="{{ t('sell_price') }} ({{ CURRENCY }})" required>
  <button type="submit" class="btn btn-primary btn-sm" data-lock>{{ t('sell') }}</button>
</form>

<script>
  // Prefill sell price (UI currency)
  const priceMap = {
    {% for item in inventory %}
      "{{ item[0] }}": {{ (item[3] | ccy) }}{{ "," if not loop.last else "" }}
    {% endfor %}
  };
  (function () {
    const sel = document.getElementById('sell-item-select');
    const priceInput = document.getElementById('sell-price');
    if (!sel || !priceInput) return;
    function setPrice() {
      const v = priceMap[sel.value];
      priceInput.value = (v != null && !isNaN(v)) ? String(Math.round(Number(v))) : "";
      priceInput.dispatchEvent(new Event('input', { bubbles: true }));
    }
    sel.addEventListener('change', setPrice);
    setPrice();
  })();
</script>

<!-- Add Item -->
<h2 class="section-title a-down">
  {{ t("add_item") }}
  <span class="info a-pop" role="button" tabindex="0"
        aria-label="Pricing hint"
        data-tip="Prices you enter are in UI currency {{ CURRENCY }}. They're stored internally in UZS.">
    <i class="fa-regular fa-circle-question"></i>
  </span>
</h2>
<form action="{{ url_for('add_item') }}" method="POST" class="form-row card a-up" style="padding:12px;">
  <input type="hidden" name="_csrf" value="{{ CSRF_TOKEN }}">
  <input type="text"  name="name"          placeholder="{{ t('item') }}" required>
  <input type="text"  name="buying_price"  data-money data-decimals="0" placeholder="{{ t('buy') }} ({{ CURRENCY }})" required>
  <input type="text"  name="selling_price" data-money data-decimals="0" placeholder="{{ t('sell') }} ({{ CURRENCY }})" required>
  <input type="number" name="quantity"     placeholder="{{ t('quantity') }}" min="1" required>
  <button type="submit" class="btn btn-primary btn-sm" data-lock>{{ t('add') }}</button>
</form>

<!-- Language & Currency -->
<div class="prefs-card card a-up" style="padding:14px;margin-top:8px;">
  <h3 class="prefs-title">{{ t("lang_curr") }}</h3>
  <div class="form-row" style="gap:16px;">
    <form method="POST" action="{{ url_for('set_prefs') }}" class="prefs-form" id="lang-form" style="display:flex;gap:8px;align-items:center;">
      <input type="hidden" name="_csrf" value="{{ CSRF_TOKEN }}">
      <label for="lang-select">{{ t("language") }}</label>
      <select name="lang" id="lang-select">
        <option value="en" {{ 'selected' if USER_LANG=='en' else '' }}>English</option>
        <option value="uz" {{ 'selected' if USER_LANG=='uz' else '' }}>Uzbek</option>
      </select>
      <div class="prefs-actions btn-row">
        <button type="submit" class="btn btn-primary btn-sm" data-lock>{{ t("save") }}</button>
      </div>
    </form>

    <form action="{{ url_for('set_currency') }}" method="POST" class="prefs-form" id="currency-form" style="display:flex;gap:8px;align-items:center;">
      <input type="hidden" name="_csrf" value="{{ CSRF_TOKEN }}">
      <label for="currency-select">{{ t("currency") }}</label>
      <select name="currency" id="currency-select">
        <option value="USD" {{ 'selected' if CURRENCY=='USD' else '' }}>USD ($)</option>
        <option value="AED" {{ 'selected' if CURRENCY=='AED' else '' }}>AED (د.إ)</option>
        <option value="UZS" {{ 'selected' if CURRENCY=='UZS' else '' }}>UZS (so'm)</option>
      </select>
      <div class="prefs-actions btn-row">
        <button type="submit" class="btn btn-primary btn-sm" data-lock>{{ t("save") }}</button>
        <button type="button" id="auto-detect" class="btn btn-outline btn-sm">{{ t("auto_detect") }}</button>
      </div>
    </form>
  </div>
  <small style="display:block;margin-top:8px;">
    1 USD = {{ usd_to_aed | round(2) }} AED | {{ usd_to_uzs | round(0) }} UZS | 1.00 USD
  </small>
</div>

<script>
  document.getElementById('auto-detect')?.addEventListener('click', async () => {
    try {
      const r = await fetch('/api/geo'); const geo = await r.json();
      const country = geo.country || ''; const langCode = (geo.languages || 'en').split(',')[0].split('-')[0];
      const currMap = { AE: 'AED', UZ: 'UZS', US: 'USD' };
      document.getElementById('lang-select').value = (langCode === 'uz' ? 'uz' : 'en');
      document.getElementById('currency-select').value = currMap[country] || 'USD';
    } catch (e) { console.warn('Geo detect failed', e); }
  });
</script>

<!-- Filters -->
<h2 class="filters-title a-down">{{ t("filters") }}</h2>
<p class="hint a-up">{{ t("low_stock_hint") }} {{ t("high_profit_hint") }}</p>
<form method="GET" action="{{ url_for('index') }}" class="form-row card a-up" style="padding:12px;">
  <input type="text" name="search" placeholder="{{ t('search_item') }}..." value="{{ search_query }}">
  <select name="filter">
    <option value="">{{ t('filter') }} — </option>
    <option value="low_stock"  {% if selected_filter == 'low_stock'  %}selected{% endif %}>{{ t('low_stock') }} (≤ 5)</option>
    <option value="high_profit" {% if selected_filter == 'high_profit' %}selected{% endif %}>{{ t('high_profit') }}</option>
  </select>
  <input type="hidden" name="sort" value="{{ request.args.get('sort','') }}">
  <button type="submit" class="btn btn-primary btn-sm" data-lock>{{ t('apply') }}</button>
</form>

<!-- Inventory Table -->
<h2 class="a-down">{{ t("inventory") }}</h2>

<div class="table-wrap card a-fade" data-once>
  {% set q = request.args.get('search','') %}
  {% set f = request.args.get('filter','') %}

  <div class="toolbar a-up" style="padding:10px;">
    <button id="filterBtn" class="btn btn-primary btn-sm" aria-expanded="false" aria-haspopup="true" aria-controls="filterMenu">
      {{ t('filter') }} / {{ t('sort') }}
    </button>

    <!-- Pop menu -->
    <div id="filterMenu" class="menu hidden a-pop" role="menu" aria-label="Inventory sort menu">
      <a class="menu-item" href="{{ url_for('index', sort='name_asc',  search=q, filter=f) }}">{{ t('sort_name_asc') }}</a>
      <a class="menu-item" href="{{ url_for('index', sort='name_desc', search=q, filter=f) }}">{{ t('sort_name_desc') }}</a>
      <hr class="menu-sep">
      <a class="menu-item" href="{{ url_for('index', sort='qty_desc',  search=q, filter=f) }}">{{ t('sort_qty_desc') }}</a>
      <a class="menu-item" href="{{ url_for('index', sort='qty_asc',   search=q, filter=f) }}">{{ t('sort_qty_asc') }}</a>
      <hr class="menu-sep">
      <a class="menu-item" href="{{ url_for('index', sort='price_desc', search=q, filter=f) }}">{{ t('sort_price_desc') }}</a>
      <a class="menu-item" href="{{ url_for('index', sort='price_asc',  search=q, filter=f) }}">{{ t('sort_price_asc') }}</a>
      <hr class="menu-sep">
      <a class="menu-item" href="{{ url_for('index', search=q, filter=f) }}">{{ t('reset_sort') }}</a>
    </div>
  </div>

  <style>
    .toolbar { position: relative; display:flex; gap:8px; align-items:center; margin-bottom:10px; }
    .menu.hidden { display:none; }
    #filterMenu { position:absolute; top:100%; left:0; margin-top:6px; z-index:5; padding:8px;
      border:1px solid var(--border); border-radius:10px; background:var(--card);
      box-shadow:0 8px 24px rgba(0,0,0,0.08); }
    #filterMenu .menu-item { display:block; padding:8px 12px; text-decoration:none; color:inherit; border-radius:8px; }
    #filterMenu .menu-item:hover { background:rgba(0,0,0,.06); }
    #filterMenu .menu-sep { margin:6px 0; border:none; border-top:1px solid var(--border); }
  </style>

  <script>
    (function(){
      const btn  = document.getElementById('filterBtn');
      const menu = document.getElementById('filterMenu');
      if (!btn || !menu) return;

      const openMenu = () => {
        menu.classList.remove('hidden');
        menu.classList.remove('a-pop');
        void menu.offsetWidth;
        menu.classList.add('a-pop');
        btn.setAttribute('aria-expanded', 'true');
      };
      const closeMenu = () => {
        if (!menu.classList.contains('hidden')) {
          menu.classList.add('hidden');
          btn.setAttribute('aria-expanded', 'false');
        }
      };

      btn.addEventListener('click', (e)=>{
        e.stopPropagation();
        if (menu.classList.contains('hidden')) openMenu(); else closeMenu();
      });

      document.addEventListener('click', (e)=>{ if (!menu.contains(e.target) && e.target !== btn) closeMenu(); });
      document.addEventListener('keydown', (e)=>{ if (e.key === 'Escape') closeMenu(); });

      const active = new URLSearchParams(location.search).get('sort') || '';
      document.querySelectorAll('#filterMenu .menu-item').forEach(a=>{
        if (active && a.href.includes(`sort=${active}`)) a.style.fontWeight = '700';
      });
    })();
  </script>

  <table id="inventoryTable" class="table a-fade" data-once>
    <thead class="a-down" data-once>
      <tr>
        <th>#</th>
        <th>{{ t("item") }}</th>
        <th>{{ t("quantity") }}</th>
        <th>{{ t("buy") }} ({{ CURRENCY }})</th>
        <th>{{ t("sell") }} ({{ CURRENCY }})</th>
        <th>{{ t("profit") }} ({{ CURRENCY }})</th>
        <th>{{ t("action") }}</th>
      </tr>
    </thead>
    <tbody class="stagger">
      {% for it in inventory %}
        <tr>
          <td>{{ loop.index }}</td>
          <td>{{ it[1] }}</td>
          <td>{{ it[4] | comma }}</td>
          <td>{{ (it[2] | ccy) | fmtmoney }}</td>
          <td>{{ (it[3] | ccy) | fmtmoney }}</td>
          <td>{{ (it[5] | ccy) | fmtmoney }}</td>
          <td>
            <a href="{{ url_for('edit_item', item_id=it[0]) }}" class="btn btn-ghost btn-xs">{{ t('edit') or 'Edit' }}</a>
            <!-- Delete removed here by request -->
          </td>
        </tr>
      {% else %}
        <tr><td colspan="7" style="text-align:center; opacity:.7">{{ t('no_items') or 'No items found.' }}</td></tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<!-- Sold Items -->
<h2 class="mt-6 a-down">{{ t('sold_items') or 'Sold Items' }}{% if selected_from or selected_to %} ({{ selected_from }} → {{ selected_to }}){% endif %}</h2>
<p class="subtitle a-up">{{ t('sold_items_hint') or 'Return puts the quantity back into Inventory and removes this sale from today.' }}</p>
<div class="table-wrap card a-fade">
  <table class="table">
    <thead>
      <tr>
        <th>#</th><th>{{ t("item") }}</th><th>{{ t("qty") }}</th>
        <th>{{ t("sell") }} ({{ CURRENCY }})</th><th>{{ t("profit") }} ({{ CURRENCY }})</th><th>{{ t("action") }}</th>
      </tr>
    </thead>
    <tbody>
      {% for s in sales_today %}
        <tr>
          <td>{{ loop.index }}</td>
          <td>{{ s[2] }}</td>
          <td>{{ s[3] }}</td>
          <td>{{ s[4] | ccy | fmtmoney }}</td>
          <td>{{ s[5] | ccy | fmtmoney }}</td>
          <td class="actions">
            <!-- Return sale (inline admin password) -->
            <form method="POST" action="{{ url_for('return_sale', sale_id=s[0]) }}" style="display:inline">
              <input type="hidden" name="_csrf" value="{{ CSRF_TOKEN }}">
              <input type="password" name="admin_password" placeholder="Admin password"
                     required aria-label="Admin password" autocomplete="current-password"
                     style="width:140px;margin-right:6px;">
              <button class="btn btn-yellow btn-xs" type="submit">{{ t('return') or 'Return' }}</button>
            </form>

            <!-- Delete sale (inline admin password) -->
            <form method="POST" action="{{ url_for('delete_sale', sale_id=s[0]) }}" style="display:inline">
              <input type="hidden" name="_csrf" value="{{ CSRF_TOKEN }}">
              <input type="password" name="admin_password" placeholder="Admin password"
                     required aria-label="Admin password" autocomplete="current-password"
                     style="width:140px;margin-right:6px;">
              <button class="btn btn-red btn-xs" type="submit">{{ t('delete') or 'Delete' }}</button>
            </form>
          </td>
        </tr>
      {% else %}
        <tr><td colspan="6" style="text-align:center; opacity:.7">{{ t('no_sales') or 'No sales yet.' }}</td></tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<!-- Stock Overview -->
<section class="chart-block card chart-reveal a-up" style="padding:16px">
  <div class="row" style="display:flex;align-items:center;gap:12px;flex-wrap:wrap;justify-content:space-between">
    <h2 class="section-title a-down" style="margin:0">
      {{ t('stock_overview_title') }}
      <span class="info a-pop" tabindex="0" data-tip="{{ t('stock_overview_hint') }}"></span>
    </h2>

    <div class="chart-controls a-up stagger" style="gap:8px">
      <input id="soh-search" type="search" placeholder="{{ t('search_items') }}"
             class="input a-up"
             style="padding:8px 12px;border:1px solid var(--border);border-radius:10px;background:var(--card);color:var(--text)">

      <label class="a-up" style="display:inline-flex;align-items:center;gap:6px">
        {{ t('sort') or 'Sort' }}
        <select id="soh-sort"
                class="input"
                style="padding:8px;border:1px solid var(--border);border-radius:10px;background:var(--card);color:var(--text)">
          <option value="qty_desc">{{ t('qty_high_low') or 'Qty (high→low)' }}</option>
          <option value="value_desc">{{ t('value_high_low') or 'Value (high→low)' }}</option>
          <option value="profit_desc">{{ t('profit_unit_high_low') or 'Profit/unit (high→low)' }}</option>
          <option value="name_asc">{{ t('name_az') or 'Name (A→Z)' }}</option>
        </select>
      </label>

      <label class="a-up" style="display:inline-flex;align-items:center;gap:6px">
        Top N
        <input id="soh-topn" type="number" min="1" step="1" value="25"
               class="input"
               style="width:80px;padding:8px;border:1px solid var(--border);border-radius:10px;background:var(--card);color:var(--text)">
      </label>

      <label class="a-up" style="display:inline-flex;align-items:center;gap:6px">
        <input id="soh-hide-zero" type="checkbox" checked> {{ t('hide_zero_qty') or 'Hide zero qty' }}
      </label>

      <button id="soh-reset" class="btn btn-outline btn-sm a-up">{{ t('reset_view') or 'Reset view' }}</button>
    </div>
  </div>

  <div class="chart-card chart-reveal" style="height:420px;margin-top:10px">
    <canvas id="stockOverview"></canvas>
  </div>
</section>

<script>
(function () {
  const el = document.getElementById("stockOverview");
  if (!el) return;
  const ctx = el.getContext("2d");
  const wrap = el.closest(".chart-reveal");
  const currency = "{{ CURRENCY }}";
  const T = {{ {"quantity": t("quantity"), "stock_value": t("stock_value")} | tojson }};
  let stockData = [];
  let chart;

  function renderChart(filtered) {
    if (chart) chart.destroy();
    chart = new Chart(ctx, {
      type: "bar",
      data: {
        labels: filtered.map(i => i.name),
        datasets: [
          { 
            label: T.quantity,
            data: filtered.map(i => i.qty),
            yAxisID: "y",
            borderWidth: 1,
            backgroundColor: "rgba(59,130,246,0.6)",
            borderColor: "rgb(59,130,246)"
          },
          { 
            label: `${T.stock_value} (${currency})`,
            data: filtered.map(i => i.value),
            type: "line",
            yAxisID: "y1",
            tension: .3,
            borderColor: "rgb(16,185,129)",
            backgroundColor: "rgba(16,185,129,0.3)",
            pointBackgroundColor: "rgb(16,185,129)",
            pointBorderColor: "#fff",
            pointRadius: 3,
            pointHoverRadius: 5
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        interaction: { mode: "index", intersect: false },
        scales: {
          y:  { beginAtZero: true, title: { display: true, text: T.quantity } },
          y1: { beginAtZero: true, position: "right", grid: { drawOnChartArea: false },
                title: { display: true, text: `${T.stock_value} (${currency})` } }
        },
        plugins: {
          legend: { display: true },
          tooltip: {
            callbacks: {
              label: (ctx) => ctx.dataset.yAxisID === "y1"
                ? `${ctx.dataset.label}: ${Math.round(ctx.parsed.y).toLocaleString()} ${currency}`
                : `${ctx.dataset.label}: ${ctx.parsed.y.toLocaleString()}`
            }
          }
        },
        animation: {
          duration: 700,
          easing: "easeOutQuart",
          onComplete: () => { if (wrap) wrap.classList.add("in"); }
        },
        hover: { animationDuration: 120 }
      }
    });
  }

  function applyFilters() {
    let data = [...stockData];
    const q = (document.getElementById("soh-search")?.value || "").toLowerCase();
    const sort = document.getElementById("soh-sort")?.value || "qty_desc";
    const topN = parseInt(document.getElementById("soh-topn")?.value, 10) || data.length;
    const hideZero = !!document.getElementById("soh-hide-zero")?.checked;

    if (q) data = data.filter(i => (i.name || "").toLowerCase().includes(q));
    if (hideZero) data = data.filter(i => (i.qty || 0) > 0);

    switch (sort) {
      case "qty_desc":    data.sort((a,b)=> (b.qty||0) - (a.qty||0)); break;
      case "value_desc":  data.sort((a,b)=> (b.value||0) - (a.value||0)); break;
      case "profit_desc": data.sort((a,b)=> (b.profit_per||0) - (a.profit_per||0)); break;
      case "name_asc":    data.sort((a,b)=> (a.name||"").localeCompare(b.name||"")); break;
    }
    renderChart(data.slice(0, topN));
  }

  ["soh-search","soh-sort","soh-topn","soh-hide-zero"].forEach(id=>{
    document.getElementById(id)?.addEventListener("input", applyFilters);
  });
  document.getElementById("soh-reset")?.addEventListener("click", () => {
    const q = document.getElementById("soh-search"); if (q) q.value = "";
    const s = document.getElementById("soh-sort");   if (s) s.value = "qty_desc";
    const n = document.getElementById("soh-topn");   if (n) n.value = 25;
    const z = document.getElementById("soh-hide-zero"); if (z) z.checked = true;
    applyFilters();
  });

  fetch("{{ url_for('api_stock_overview') }}", { credentials: "same-origin" })
    .then(r => r.ok ? r.json() : { items: [] })
    .then(d => {
      stockData = (d.items || []).map(i => ({
        name: i.name, qty: Number(i.qty)||0, value: Number(i.value)||0,
        profit_per: Number(i.profit_per ?? i.profit_per_unit ?? 0)
      }));
      if (wrap) wrap.classList.remove("in");
      applyFilters();
    })
    .catch(err => { console.warn("stock overview fetch failed:", err); stockData = []; if (wrap) wrap.classList.add("in"); applyFilters(); });
})();
</script>

<!-- Live input money formatter -->
<script>
(function () {
  const inputs = document.querySelectorAll("[data-money]");
  function fmt(raw){ const s=String(raw||"").replace(/[^\d]/g,""); return s? s.replace(/\B(?=(\d{3})+(?!\d))/g,",") : ""; }
  function unfmt(s){ return String(s||"").replace(/,/g,""); }
  inputs.forEach(inp => {
    if (inp.value) inp.value = fmt(inp.value);
    inp.addEventListener("input", () => {
      const start = inp.selectionStart || 0, before = inp.value;
      inp.value = fmt(before); const diff = inp.value.length - before.length;
      try { inp.setSelectionRange(Math.max(0, start + diff), Math.max(0, start + diff)); } catch(e) {}
    });
    inp.addEventListener("blur", () => { inp.value = fmt(inp.value); });
    if (inp.form) inp.form.addEventListener("submit", () => { inp.value = unfmt(inp.value); });
  });
})();
</script>

<!-- Export & Backup -->
<h2 class="export-title a-down">{{ t("export_backup") }}</h2>
<p class="hint a-up">
  <strong>{{ t("download_excel") }}</strong> — export your current inventory.<br>
  <strong>{{ t("backup_now") }}</strong> — create a ZIP with CSVs of your tables.
</p>
<div class="form-row card a-up" style="padding:12px;">
  <a href="{{ url_for('export_excel') }}" class="btn btn-green btn-sm">&#128202; {{ t("export_excel") }}</a>
  <a href="{{ url_for('admin_backup') }}" class="btn btn-ghost btn-sm">&#128190; {{ t("backup_db") }}</a>
</div>

<!-- Submit-based double-click guard (doesn't block submit) -->
<script>
  document.addEventListener('submit', function (e) {
    try {
      const btn = e.submitter;
      if (btn && btn.matches('button.btn[data-lock]')) {
        btn.disabled = true;
        setTimeout(() => { try { btn.disabled = false; } catch(_){} }, 2000);
      }
    } catch(_) {}
  }, true);
</script>

{% endblock %}
