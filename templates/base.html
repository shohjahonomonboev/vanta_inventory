<!DOCTYPE html>
<html lang="{{ USER_LANG or 'en' }}">
<head>
  <meta name="csrf-token" content="{{ CSRF_TOKEN }}">
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="color-scheme" content="light dark" />
  <title>{% block title %}Jasurbek Inventory{% endblock %}</title>

  <!-- Theme prepaint (no flash) -->
  <script>
    (function () {
      try {
        var t = localStorage.getItem('vanta-theme');
        if (!t) t = (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) ? 'dark' : 'light';
        document.documentElement.setAttribute('data-theme', t);
        document.documentElement.style.backgroundColor = (t === 'dark') ? '#0b1220' : '#f6f7fb';
      } catch (e) {}
    })();
  </script>

  <!-- Fonts & CSS -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

  <!-- Motion & App CSS -->
  <link rel="stylesheet" href="{{ url_for('static', filename='motion.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}?v={{ APP_VERSION }}">

  <!-- Icons -->
  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
        crossorigin="anonymous" referrerpolicy="no-referrer">

  {% set AUTH_PAGES = ['login','forgot_password','forgot_password_post'] %}
  {% if request.endpoint not in AUTH_PAGES %}
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3"></script>
  {% endif %}

  {% block head %}{% endblock %}
</head>
<body class="{% if request.endpoint in AUTH_PAGES %}no-chrome{% endif %}">

  {% if request.endpoint not in AUTH_PAGES %}
  <header class="topbar card container a-down" role="banner" data-once>
    <div class="brand">
      <span class="cube" aria-hidden="true">&#x1F4E6;</span>
      <strong>Jasurbek Inventory</strong>
      <span class="badge badge-version" title="Current build">{{ APP_VERSION }}</span>
    </div>
    <div class="actions-row">
      <button id="themeToggle" class="btn btn-outline" type="button" title="{{ t('toggle_theme') }}">{{ t('toggle_theme') }}</button>
      <a href="{{ url_for('logout') }}" class="btn btn-red logout">{{ t('logout') }}</a>
    </div>
  </header>
  {% endif %}

  {% if request.endpoint not in AUTH_PAGES %}
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      <div class="flash-area container a-up" role="status" aria-live="polite">
        {% for category, msg in messages %}
          <div class="flash toast {{ category }}">{{ msg }}</div>
        {% endfor %}
      </div>
    {% endif %}
  {% endwith %}
  {% endif %}

  <main class="container a-fade" role="main" data-once>
    {% block content %}{% endblock %}
  </main>

  {% if request.endpoint not in AUTH_PAGES %}
  <footer class="footer container a-up" role="contentinfo" data-once>
    {{ t('Made with ‚ö° by Shon') }} ‚Äî {{ APP_VERSION }}
  </footer>
  {% endif %}

  <!-- Theme toggle -->
  <script>
    (function () {
      const toggle = document.getElementById('themeToggle');
      if (!toggle) return;
      toggle.addEventListener('click', () => {
        const root = document.documentElement;
        const next = root.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
        root.setAttribute('data-theme', next);
        root.style.backgroundColor = (next === 'dark') ? '#0b1220' : '#f6f7fb';
        try { localStorage.setItem('vanta-theme', next); } catch (e) {}
        document.dispatchEvent(new CustomEvent('vanta-theme-change', { detail: { theme: next } }));
      });
    })();
  </script>

  <!-- Motion JS (after content) -->
  <script src="{{ url_for('static', filename='motion.js') }}" defer></script>

  <!-- CSRF helpers (consolidated) -->
  <script>
    (function () {
      const token = "{{ CSRF_TOKEN }}";
      window.CSRF_TOKEN = token;

      function ensureCsrf(form) {
        if (!form || form.__csrfBound) return;
        const method = (form.getAttribute('method') || 'get').toUpperCase();
        if (['POST','PUT','PATCH','DELETE'].includes(method)) {
          if (!form.querySelector('input[name="_csrf"]')) {
            const i = document.createElement('input');
            i.type = 'hidden'; i.name = '_csrf'; i.value = token;
            form.appendChild(i);
          }
          form.__csrfBound = true;
        }
      }
      const scan = () => document.querySelectorAll('form').forEach(ensureCsrf);
      if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', scan); else scan();
      new MutationObserver(scan).observe(document.documentElement, { childList: true, subtree: true });

      const _fetch = window.fetch;
      window.fetch = function (input, init = {}) {
        const req = new Request(input, init);
        const unsafe = ['POST','PUT','PATCH','DELETE'].includes((req.method || 'GET').toUpperCase());
        if (unsafe) {
          const headers = new Headers(init.headers || req.headers || {});
          if (!headers.has('X-CSRF-Token')) headers.set('X-CSRF-Token', token);
          init.headers = headers;
        }
        return _fetch(input, init);
      };
    })();
  </script>

  <!-- Flash auto-dismiss -->
  <script>
    (function(){
      const flashes = document.querySelectorAll('.flash-area .flash');
      flashes.forEach((el, i) => {
        const life = 3000 + i * 500;
        setTimeout(() => el.classList.add('hide'), life);
        setTimeout(() => el.remove(), life + 500);
      });
    })();
  </script>

  <!-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
  <!-- üîê Global Admin Password Modal + Hooks                       -->
  <!-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
  <div id="adminModal" class="modal" style="display:none;">
    <div id="adminModalBox" class="modal-content">
      <span class="close" id="adminModalClose" aria-label="Close">&times;</span>
      <h3 id="adminModalTitle">Enter Admin Password</h3>
      <p id="adminModalDesc"></p>
      <p id="lockoutMsg" style="display:none;margin:6px 0 0;"></p>
      <form id="adminForm" method="POST">
        <div class="password-field">
          <input id="adminPasswordInput" type="password" placeholder="Password" required aria-label="Admin password" autocomplete="current-password">
          <button id="toggleEye" type="button" class="toggle-eye" aria-label="Show password" aria-pressed="false">üëÅÔ∏è</button>
        </div>
        <button id="adminConfirmBtn" type="submit" class="btn">Confirm</button>
      </form>
    </div>
  </div>

  <style>
    .modal { position: fixed; inset: 0; z-index: 1000; background: rgba(0,0,0,.6); display: none; justify-content: center; align-items: center; }
    .modal.show { display: flex; }
    .modal-content { background: var(--card); padding: 20px; border-radius: 12px; min-width: 300px; box-shadow: 0 5px 20px rgba(0,0,0,.3); }
    .close { float:right; font-size:20px; cursor:pointer; }
    .password-field { position:relative; }
    .password-field input[type="password"], .password-field input[type="text"] { width:100%; padding:8px 40px 8px 10px; border-radius:8px; outline:none; margin-bottom:12px; border:2px solid var(--border); background:var(--card); color:var(--text); }
    .toggle-eye { position:absolute; right:10px; top:50%; transform:translateY(-50%); border:0; background:transparent; cursor:pointer; font-size:16px; line-height:1; opacity:.75; }
    .toggle-eye:hover { opacity:1; }
    .text-red{color:var(--red)} .text-blue{color:var(--primary)} .text-green{color:var(--green)}
    .glow-red{ box-shadow:0 0 20px rgba(239,68,68,.6), 0 5px 20px rgba(0,0,0,.3) }
    .glow-blue{ box-shadow:0 0 20px rgba(37,99,235,.6), 0 5px 20px rgba(0,0,0,.3) }
    .glow-green{ box-shadow:0 0 20px rgba(16,185,129,.6), 0 5px 20px rgba(0,0,0,.3) }
    .input-red{border-color:var(--red)!important} .input-blue{border-color:var(--primary)!important} .input-green{border-color:var(--green)!important}
    @keyframes shake { 0%{transform:translateX(0)}20%{transform:translateX(-6px)}40%{transform:translateX(6px)}60%{transform:translateX(-4px)}80%{transform:translateX(4px)}100%{transform:translateX(0)} }
    .shake{animation:shake .4s}
  </style>

  <script>
    (function(){
      let pendingForm = null;
      let lockoutTimer = null;

      function setPasswordVisible(v){
        const inp = document.getElementById("adminPasswordInput");
        const tgl = document.getElementById("toggleEye");
        inp.type = v ? "text" : "password";
        tgl.setAttribute("aria-pressed", v ? "true" : "false");
        tgl.textContent = v ? "üôà" : "üëÅÔ∏è";
      }

      function openAdminModal(actionType, itemName){
        const modal = document.getElementById("adminModal");
        const box   = document.getElementById("adminModalBox");
        const title = document.getElementById("adminModalTitle");
        const desc  = document.getElementById("adminModalDesc");
        const btn   = document.getElementById("adminConfirmBtn");
        const input = document.getElementById("adminPasswordInput");
        const msg   = document.getElementById("lockoutMsg");

        box.className="modal-content"; title.className=""; btn.className="btn"; input.className="";
        if (actionType === "delete"){ title.classList.add("text-red");   box.classList.add("glow-red");   btn.classList.add("btn-red");   input.classList.add("input-red");   title.textContent="Confirm Deletion"; desc.textContent=`Delete: ${itemName}?`; }
        else if (actionType === "return"){ title.classList.add("text-green"); box.classList.add("glow-green"); btn.classList.add("btn-green"); input.classList.add("input-green"); title.textContent="Confirm Return"; desc.textContent=`Return: ${itemName}?`; }
        else { title.classList.add("text-blue"); box.classList.add("glow-blue"); title.textContent="Enter Admin Password"; desc.textContent=""; }

        setPasswordVisible(false);
        input.value = "";
        msg.style.display = "none";
        msg.textContent = "";

        modal.classList.add("show");
        checkLockoutAndUpdate();
      }

      function closeAdminModal(){
        document.getElementById("adminModal").classList.remove("show");
        clearInterval(lockoutTimer);
      }

      document.getElementById("toggleEye")?.addEventListener("click", ()=>{
        const inp = document.getElementById("adminPasswordInput");
        setPasswordVisible(inp.type !== "text");
      });
      document.getElementById("adminModalClose")?.addEventListener("click", closeAdminModal);
      document.getElementById("adminModal")?.addEventListener("click",(e)=>{ if(e.target===e.currentTarget) closeAdminModal(); });
      document.addEventListener("keydown",(e)=>{ if(e.key==="Escape") closeAdminModal(); });

      async function fetchLockoutRemaining(){
        try{ const r=await fetch("/admin/lockout",{cache:"no-store",credentials:"same-origin"}); const j=await r.json(); return j.remaining||0; }
        catch{ return 0; }
      }
      function setLockedUI(remain){
        const btn=document.getElementById("adminConfirmBtn");
        const inp=document.getElementById("adminPasswordInput");
        const msg=document.getElementById("lockoutMsg");
        if(remain>0){ btn.disabled=true; inp.disabled=true; msg.style.display="block"; msg.textContent=`‚è≥ Locked: ${remain}s`; }
        else{ btn.disabled=false; inp.disabled=false; msg.style.display="none"; msg.textContent=""; }
      }
      function startCountdown(n){
        clearInterval(lockoutTimer); let remain=n; setLockedUI(remain);
        lockoutTimer=setInterval(()=>{ remain-=1; if(remain<=0){ clearInterval(lockoutTimer); setLockedUI(0);} else setLockedUI(remain); },1000);
      }
      async function checkLockoutAndUpdate(){
        const remain=await fetchLockoutRemaining();
        if(remain>0) startCountdown(remain); else setLockedUI(0);
      }

      // Modal submit -> inject hidden admin_password then submit original form
      document.getElementById("adminForm")?.addEventListener("submit", function(e){
        e.preventDefault();
        const btn=document.getElementById("adminConfirmBtn");
        if(btn.disabled) return;
        if(!pendingForm){ closeAdminModal(); return; }
        const pw=document.getElementById("adminPasswordInput").value || "";
        let hid=pendingForm.querySelector('input[name="admin_password"]');
        if(!hid){ hid=document.createElement("input"); hid.type="hidden"; hid.name="admin_password"; pendingForm.appendChild(hid); }
        hid.value=pw;
        closeAdminModal();
        pendingForm.submit();
      });

      function nameFromRow(form){
        const row=form.closest("tr");
        const cell=row?.querySelector("td:nth-child(2)");
        return (cell?.textContent || "").trim() || "this item";
      }

      function hookProtectedForms(){
        const forms = Array.from(document.querySelectorAll('form.needs-admin'));
        // Add pattern hooks too (defensive)
        forms.push(...document.querySelectorAll('form[action^="/delete/"]:not([action*="/sales/"])'));
        forms.push(...document.querySelectorAll('form[action*="/sales/"][action$="/return"]'));
        forms.push(...document.querySelectorAll('form[action*="/sales/"][action$="/delete"]'));
        forms.push(...document.querySelectorAll('form[action*="/items/"][action$="/return"]'));

        forms.forEach(form=>{
          // avoid double-binding
          if (form.__adminBound) return;
          form.__adminBound = true;

          form.addEventListener("submit", function(ev){
            // If the form already has a filled admin_password, let it post.
            const existing = form.querySelector('input[name="admin_password"]');
            if (existing && existing.value.trim() !== '') return;

            ev.preventDefault();
            pendingForm = form;

            const act = (form.getAttribute("action") || "");
            let type = "auth";
            if (act.includes("/delete")) type = "delete";
            else if (act.includes("/return")) type = "return";

            openAdminModal(type, nameFromRow(form));
          }, {capture:true});
        });
      }

      if(document.readyState==="loading") document.addEventListener("DOMContentLoaded", hookProtectedForms);
      else hookProtectedForms();

      // Fallback: prompt if modal fails to show for any reason
      window.addEventListener('error', () => {
        // noop; the forms will still post if user typed a password field present
      });
    })();
  </script>

  {% block body_end %}{% endblock %}
</body>
</html>
